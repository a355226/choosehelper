<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æ±ºç­–å°å¹«æ‰‹-å»ºç«‹æˆ¿é–“</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link rel="icon" type="image/png" sizes="32x32" href="icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="icon.png">
<link rel="manifest" href="manifest.json">
<style>
Â Â body {
Â Â Â Â font-family: "Segoe UI", sans-serif;
Â Â Â Â background-color: #f0f9ff;
Â Â Â Â margin: 0;
Â Â Â Â padding: 0;
Â Â Â Â color: #2c3e50;
Â Â }
Â Â h1 {
Â Â Â Â text-align: center;
Â Â Â Â padding: 20px 10px;
Â Â Â Â margin: 0;
Â Â Â Â font-weight: 600;
Â Â Â Â font-size: 1.6em;
Â Â }
Â Â .page {
Â Â Â Â display: none;
Â Â Â Â padding: 20px;
Â Â Â Â max-width: 600px;
Â Â Â Â margin: auto;
Â Â }
Â Â .page.active {
Â Â Â Â display: block;
Â Â }
.btn-primary, .btn-confirm {
Â Â border: none;
Â Â border-radius: 10px;
Â Â padding: 10px 18px;
Â Â font-size: 15px;
Â Â font-weight: 600;
Â Â cursor: pointer;
Â Â box-shadow:
Â Â Â Â 0 3px 12px -4px #3db8c455, /* ä¸»è‰²ç³»æ·¡é™°å½± */
Â Â Â Â 0 1.5px 0 #fff5, Â  Â  Â  Â  Â  /* ä¸Šæ–¹ä¸€é»äº®ç·š */
Â Â Â Â 0 0.5px 4px #35a4af18; Â  Â  /* ä¸‹æ–¹æŸ”å’Œè—æšˆ */
Â Â transition: background 0.18s, transform 0.09s, box-shadow 0.19s;
Â Â position: relative;
Â Â overflow: hidden;
}

/* --- è³ªæ„Ÿæ¼¸å±¤ä¸»æŒ‰éˆ• --- */
.btn-primary {
Â Â background: linear-gradient(120deg, #3db8c4 60%, #35a4af 100%);
Â Â color: #fff;
}
.btn-primary::after {
Â Â content: '';
Â Â display: block;
Â Â position: absolute;
Â Â top: 0; left: 0; right: 0; height: 46%;
Â Â background: linear-gradient(120deg, #fff3 5%, #fff1 100%);
Â Â border-radius: 10px 10px 50% 50% / 38% 38% 55% 55%;
Â Â pointer-events: none;
Â Â z-index: 1;
Â Â opacity: 0.68;
}
.btn-primary:hover {
Â Â background: linear-gradient(120deg, #35a4af 0%, #3db8c4 80%);
Â Â box-shadow:
Â Â Â Â 0 5px 20px -6px #3db8c488,
Â Â Â Â 0 2.5px 0 #fff6,
Â Â Â Â 0 2px 12px #3db8c42e;
Â Â transform: translateY(-1px) scale(1.04);
}
.btn-primary:active {
Â Â background: linear-gradient(120deg, #33a7b3 0%, #43d0e1 100%);
Â Â box-shadow:
Â Â Â Â 0 1px 6px #3db8c466;
Â Â transform: scale(0.98);
}

/* --- è³ªæ„Ÿæ©˜ç´…ä¸»æŒ‰éˆ• --- */
.btn-confirm {
Â Â background: linear-gradient(120deg, #fc806d 65%, #ff9a7c 100%);
Â Â color: #fff;
}
.btn-confirm::after {
Â Â content: '';
Â Â display: block;
Â Â position: absolute;
Â Â top: 0; left: 0; right: 0; height: 44%;
Â Â background: linear-gradient(120deg, #fff2 10%, #fff1 100%);
Â Â border-radius: 10px 10px 40% 40% / 36% 36% 60% 60%;
Â Â pointer-events: none;
Â Â z-index: 1;
Â Â opacity: 0.61;
}
.btn-confirm:hover {
Â Â background: linear-gradient(120deg, #ff9a7c 0%, #fc806d 90%);
Â Â box-shadow:
Â Â Â Â 0 5px 22px -6px #fc806d99,
Â Â Â Â 0 2.5px 0 #fff6,
Â Â Â Â 0 2px 12px #ff9a7c26;
Â Â transform: translateY(-1px) scale(1.045);
}
.btn-confirm:active {
Â Â background: linear-gradient(120deg, #fb674a 0%, #fc806d 100%);
Â Â box-shadow:
Â Â Â Â 0 1px 6px #fc806d55;
Â Â transform: scale(0.97);
}

.btn-confirm-red {
Â Â background: linear-gradient(120deg, #fc3a52 5%, #d7263d 80%, #b31217 100%);
Â Â color: #fff;
Â Â border: none;
Â Â border-radius: 16px;
Â Â padding: 12px 22px;
Â Â font-size: 1.13em;
Â Â font-weight: bold;
Â Â cursor: pointer;
Â Â box-shadow:Â 
Â Â Â Â 0 3px 18px -4px #fc3a5244, /* æŸ”ç´…å…‰æšˆ */
Â Â Â Â 0 1.5px 0 #fff5, Â  Â  Â  Â  Â  /* ä¸Šå´å¾®å¾®äº®å…‰ */
Â Â Â Â 0 1.5px 16px #b3121722;Â  Â  /* ä¸‹å´æŠ•å½± */
Â Â transition: background 0.2s, transform 0.11s, box-shadow 0.23s;
Â Â letter-spacing: 1.1px;
Â Â position: relative;
Â Â overflow: hidden;
}

.btn-confirm-red::after {
Â Â content: '';
Â Â display: block;
Â Â position: absolute;
Â Â top: 0; left: 0; right: 0; height: 40%;
Â Â background: linear-gradient(120deg, #fff4 5%, #fff2 90%);
Â Â border-radius: 14px 14px 60% 60% / 30% 30% 60% 60%;
Â Â pointer-events: none;
Â Â z-index: 1;
Â Â opacity: 0.65;
}

.btn-confirm-red:hover {
Â Â background: linear-gradient(120deg, #ff5b70 0%, #fc3a52 50%, #b31217 100%);
Â Â box-shadow:
Â Â Â Â 0 4px 24px -4px #ff5b705a,
Â Â Â Â 0 2px 0 #fff6,
Â Â Â Â 0 2.5px 18px #b3121735;
Â Â transform: translateY(-2px) scale(1.045);
}

.btn-confirm-red:active {
Â Â background: linear-gradient(120deg, #b31217 0%, #fc3a52 90%);
Â Â box-shadow:
Â Â Â Â 0 1.5px 6px #b3121755;
Â Â transform: scale(0.98);
}

Â Â input {
Â Â Â Â padding: 10px;
Â Â Â Â font-size: 16px;
Â Â Â Â margin: 10px 0;
Â Â Â Â border-radius: 8px;
Â Â Â Â border: 1px solid #ccc;
Â Â Â Â width: 100%;
Â Â Â Â box-sizing: border-box;
Â Â Â Â transition: border 0.2s, box-shadow 0.2s;
Â Â }
Â Â input:focus {
Â Â Â Â border-color: #3db8c4;
Â Â Â Â box-shadow: 0 0 5px rgba(61, 184, 196, 0.5);
Â Â Â Â outline: none;
Â Â }
Â Â .item-container {
Â Â Â Â display: flex;
Â Â Â Â flex-wrap: wrap;
Â Â Â Â gap: 8px;
Â Â Â Â max-height: calc(1.8em * 3 + 20px);
Â Â Â Â overflow-y: auto;
Â Â Â Â padding: 6px;
Â Â Â Â background: #ffffffcc;
Â Â Â Â border-radius: 10px;
Â Â }
Â Â .item-box {
Â Â Â Â background: #e0f4ff;
Â Â Â Â border-radius: 16px;
Â Â Â Â padding: 6px 12px;
Â Â Â Â font-size: 14px;
Â Â Â Â white-space: nowrap;
Â Â Â Â max-width: 150px;
Â Â Â Â overflow: hidden;
Â Â Â Â text-overflow: ellipsis;
Â Â Â Â display: flex;
Â Â Â Â align-items: center;
Â Â }
Â Â .remove-btn {
Â Â Â Â background: none;
Â Â Â Â border: none;
Â Â Â Â color: #c0392b;
Â Â Â Â font-size: 16px;
Â Â Â Â cursor: pointer;
Â Â Â Â margin-left: 6px;
Â Â Â Â flex-shrink: 0;
Â Â }
Â Â .header-row {
Â Â Â Â display: flex;
Â Â Â Â justify-content: space-between;
Â Â Â Â align-items: center;
Â Â Â Â flex-wrap: wrap;
Â Â Â Â gap: 10px;
Â Â Â Â margin-bottom: 12px;
Â Â }
Â Â .modal {
Â Â Â Â position: fixed;
Â Â Â Â top: 0; left: 0; right: 0; bottom: 0;
Â Â Â Â background: rgba(0,0,0,0.65);
Â Â Â Â display: flex;
Â Â Â Â justify-content: center;
Â Â Â Â align-items: center;
Â Â Â Â z-index: 9999;
Â Â }
Â Â .modal-content {
Â Â Â Â background: white;
Â Â Â Â max-width: 90%;
Â Â Â Â max-height: 80%;
Â Â Â Â overflow-y: auto;
Â Â Â Â padding: 20px;
Â Â Â Â border-radius: 12px;
Â Â Â Â text-align: center;
Â Â }
Â Â .modal-content button {
Â Â Â Â margin: 6px 6px;
Â Â }
Â Â .hidden { display: none; }
Â Â @keyframes spin {
Â Â Â Â Â Â from { transform: rotate(0deg); }
Â Â Â Â Â Â to { transform: rotate(360deg); }
Â Â }
Â Â .spin-animation {
Â Â Â Â Â Â animation: spin 1s linear infinite;
Â Â Â Â Â Â display: inline-block;
Â Â }
Â Â .result-final {
Â Â Â Â font-size: 1.8em;
Â Â Â Â color: #3db8c4;
Â Â Â Â font-weight: bold;
Â Â Â Â animation: pulse 1s infinite;
Â Â }
Â Â @keyframes pulse {
Â Â Â Â 0% { transform: scale(1); }
Â Â Â Â 50% { transform: scale(1.1); }
Â Â Â Â 100% { transform: scale(1); }
Â Â }
Â Â .debug-box {
Â Â Â Â position: fixed;
Â Â Â Â bottom: 10px;
Â Â Â Â right: 10px;
Â Â Â Â width: 300px;
Â Â Â Â height: 150px;
Â Â Â Â background: #f0f0f0;
Â Â Â Â border: 1px solid #000;
Â Â Â Â overflow-y: auto;
Â Â Â Â padding: 10px;
Â Â Â Â font-size: 12px;
Â Â Â Â z-index: 10000;
Â Â Â Â font-family: monospace;
Â Â }
Â Â .debug-box { display: none !important; }

.exit-btn {
Â Â position: fixed;
Â Â top: 14px;
Â Â right: 14px;
Â Â width: 40px;
Â Â height: 40px;
Â Â background: url('https://cdn.jsdelivr.net/gh/a355226/choosehelper@main/exit.jpg') center center no-repeat;
Â Â background-size: 24px 24px;
Â Â border-radius: 50%;
Â Â box-shadow: 0 2px 8px rgba(0,0,0,0.05);
Â Â opacity: 0.7;
Â Â cursor: pointer;
Â Â z-index: 20000;
Â Â transition: opacity 0.2s, box-shadow 0.2s;
Â Â background-color: #e7faf1;
Â Â border: 1.5px solid #dbf4e6;
}
.exit-btn:hover {
Â Â opacity: 1;
Â Â box-shadow: 0 3px 10px rgba(50,150,120,0.18);
Â Â background-color: #d1f7e4;
}

.btn-draw {
Â Â background: linear-gradient(90deg, #FFD267 40%, #FFB85C 100%);
Â Â color: #323e50;
Â Â border: none;
Â Â border-radius: 18px;
Â Â font-size: 1.5em;
Â Â font-weight: 700;
Â Â padding: 18px 38px;
Â Â box-shadow: 0 6px 20px rgba(255, 213, 103, 0.13);
Â Â cursor: pointer;
Â Â transition: background 0.18s, transform 0.08s;
Â Â margin: 22px auto 10px auto;
Â Â display: block;
Â Â letter-spacing: 2px;
}
.btn-draw:hover {
Â Â background: linear-gradient(90deg, #FFB85C 40%, #FFA63C 100%);
Â Â color: #fff;
Â Â transform: scale(1.07);
Â Â box-shadow: 0 8px 24px rgba(255, 184, 92, 0.19);
}

/* æ±ºå®šæ–¹å¼å­—é«”è‰²å½©æ›´èåˆ */
#decideModeDisplay {
Â Â color: #FF7577 !important; /* è¼ƒæ·ºç´…æ©˜ */
Â Â background: linear-gradient(135deg, rgba(255, 237, 237, 0.78) 0%, rgba(255, 173, 173, 0.28) 100%);
Â Â padding: 4px 16px;
Â Â border-radius: 16px;
Â Â font-weight: bold;
Â Â font-size: 1.1em;
Â Â letter-spacing: 1.2px;
Â Â margin-top: 10px;
Â Â display: inline-block;
Â Â /* æŸ”å’Œæ·¡æ·¡çš„é™°å½± */
Â Â box-shadow: 0 2px 10px 0 rgba(255, 120, 120, 0.10);
Â Â transition: box-shadow 0.19s;
Â Â border: none;
}

.selected-mode-tag {
Â Â color: #1e4661 !important; /* æ›´æ·±è—ç° */
Â Â background: linear-gradient(120deg, rgba(239,248,255,0.97) 0%, rgba(202,231,255,0.67) 95%);
Â Â padding: 4.5px 18px;
Â Â border-radius: 18px;
Â Â font-weight: bold;
Â Â font-size: 1.12em;
Â Â letter-spacing: 1.15px;
Â Â margin-left: 8px;
Â Â display: inline-block;
Â Â vertical-align: middle;
Â Â border: none;
Â Â box-shadow:
Â Â Â Â 0 3px 16px 0 rgba(80,185,246,0.09),
Â Â Â Â 0 2px 7px 0 rgba(130,200,255,0.06),
Â Â Â Â 0 1.2px 0 #fff3;
Â Â transition: box-shadow 0.22s, background 0.14s, transform 0.14s, color 0.14s;
Â Â position: relative;
Â Â overflow: hidden;
Â Â will-change: background, box-shadow, transform;
}
.selected-mode-tag::before {
Â Â content: '';
Â Â position: absolute;
Â Â inset: 0;
Â Â background: linear-gradient(110deg, #dff8fd22 10%, #aeefff11 80%, #eaf6fb10 100%);
Â Â opacity: 0.32;Â  Â  /* æ›´æ·¡ */
Â Â filter: blur(3.8px);
Â Â pointer-events: none;
Â Â z-index: 0;
Â Â animation: tagflow 2.9s ease-in-out infinite alternate;
Â Â border-radius: 18px;
}
.selected-mode-tag::after {
Â Â content: '';
Â Â position: absolute;
Â Â left: 28%; top: 54%;
Â Â width: 36%; height: 35%;
Â Â background: linear-gradient(95deg, #fff8 12%, #eaf8ffad 92%, transparent 100%);
Â Â opacity: 0.18;Â  Â  /* å¹¾ä¹çœ‹ä¸è¦‹ï¼Œä½†æœ‰å¾®å…‰ */
Â Â filter: blur(1.8px);
Â Â border-radius: 33% 63% 40% 68% / 51% 54% 29% 52%;
Â Â pointer-events: none;
Â Â z-index: 1;
Â Â transition: opacity 0.16s;
}
/* hover/active ç‹€æ…‹ */
.selected-mode-tag:hover {
Â Â color: #0073a9 !important;
Â Â background: linear-gradient(120deg, #e4f4ff 0%, #bde8fc 95%);
Â Â box-shadow:
Â Â Â Â 0 7px 24px 0 rgba(48,180,240,0.15),
Â Â Â Â 0 3px 15px 0 rgba(130,220,255,0.12),
Â Â Â Â 0 2px 0 #fff5;
Â Â transform: scale(1.04);
}
.selected-mode-tag:active {
Â Â transform: scale(0.97);
Â Â filter: brightness(1.07);
}
.selected-mode-tag:empty { display: none; }
@keyframes tagflow {
Â Â 0% { background-position: 0% 38%; }
Â Â 100% { background-position: 100% 62%; }
}




/* å‹•ç•«å€åŸŸå¤–æ¡† */
.lottery-animate-frame {
Â Â display: flex;
Â Â align-items: center;
Â Â justify-content: center;
Â Â min-height: 120px;Â  Â  Â  /* é«˜åº¦åŠ é«˜ä¸€äº› */
Â Â min-width: 240px;
Â Â padding: 32px 36px; Â  Â  /* ä¸Šä¸‹å·¦å³éƒ½ä¸€æ¨£å¤š */
Â Â border-radius: 28px;Â  Â  /* åœ“è§’ç¨å°ä¸€é»æ›´å’Œè«§ */
Â Â background: linear-gradient(120deg, #c2e9fb 0%, #a1c4fd 50%, #70a1ff 100%);
Â Â box-shadow: 0 0 36px 0 rgba(255, 160, 90, 0.09), 0 2px 12px 0 rgba(255,77,79,0.06);
Â Â position: relative;
Â Â overflow: hidden;
Â Â transition: background 0.35s;
}

/* å­—é«”å‹•ç•« */
.lottery-animate-text {
Â Â font-size: 2.5em;
Â Â font-weight: 800;
Â Â letter-spacing: 2px;
Â Â color: #FF4D4F;
Â Â text-shadow: 0 4px 24px rgba(255,77,79,0.25), 0 1px 0 #fff;
Â Â animation: pop-in 0.33s cubic-bezier(.52,2.1,.45,.85);
Â Â will-change: transform;
Â Â user-select: none;
Â Â transition: color 0.2s;
}
@keyframes pop-in {
Â Â 0% Â  { transform: scale(0.7) rotate(-7deg);}
Â Â 60%Â  { transform: scale(1.25) rotate(3deg);}
Â Â 90%Â  { transform: scale(0.92);}
Â Â 100% { transform: scale(1);}
}
/* æœ€çµ‚å®šæ ¼é–ƒçˆæ•ˆæœ */
.lottery-final {
Â Â background: linear-gradient(98deg, #A5252B 0%, #C72A36 44%, #FFD600 51%, #C72A36 58%, #A5252B 100%);
Â Â -webkit-background-clip: text;
Â Â -webkit-text-fill-color: transparent;
Â Â background-clip: text;
Â Â text-fill-color: transparent;

Â Â font-family: 'Segoe UI', 'PingFang TC', 'Heiti TC', 'Arial', sans-serif;
Â Â font-weight: 900;
Â Â font-size: 2.7em;
Â Â letter-spacing: 2.5px;

Â Â /* ä¸»é«”æ·±ç´…ï¼Œé‡‘å…‰åæ·¡æ”¶æ–‚ */
Â Â text-shadow:
Â Â Â Â 0 1px 5px #FFD60024, Â  Â  /* æŸ”å’Œå°é‡‘æšˆ */
Â Â Â Â 0 0 1px #C72A36ee, Â  Â  /* ä¸»é™°å½±-æ·±ç´… */
Â Â Â Â 0 1.2px 0 #A5252Bdd, Â  Â  /* é‚Šç·£å£“ç·š */
Â Â Â Â 0 0 6px #FFD6001a; Â  Â  Â  /* è£œå……é‡‘å…‰ï¼Œéå¸¸æ·¡ */

Â Â animation: final-glow-redgold 1.2s ease-in-out alternate infinite;
}

@keyframes final-glow-redgold {
Â Â 0% {
Â Â Â Â text-shadow:
Â Â Â Â Â Â 0 1px 5px #FFD6001a,
Â Â Â Â Â Â 0 0 2.5px #C72A36ee,
Â Â Â Â Â Â 0 1.2px 0 #A5252Bdd,
Â Â Â Â Â Â 0 0 6px #FFD6000f;
Â Â }
Â Â 15% {
Â Â Â Â text-shadow:
Â Â Â Â Â Â 0 1px 5px #FFD60038,
Â Â Â Â Â Â 0 0 4px #C72A36cc,
Â Â Â Â Â Â 0 1.5px 0 #A5252Bcc,
Â Â Â Â Â Â 0 0 5px #FFD60022;
Â Â }
}
/* æœ€çµ‚çµæœå‹•ç•« - ä»¥äº®è—è‰²ç‚ºåŸºåº•çš„é¡è‰²é–ƒçˆï¼‹æ¼¸æ”¾å¤§ */
@keyframes blueGrowFlash {
Â Â 0% Â  { color: #0080FF; transform: scale(1);}
Â Â 20%Â  { color: #38A1FF; transform: scale(1.08);}
Â Â 40%Â  { color: #6EC1FF; transform: scale(1.14);}
Â Â 60%Â  { color: #0080FF; transform: scale(1.22);}
Â Â 80%Â  { color: #1677B3; transform: scale(1.13);}
Â Â 100% { color: #0080FF; transform: scale(1.25);}
}

.lottery-final-blue {
Â Â font-family: 'Segoe UI', 'PingFang TC', 'Heiti TC', 'Arial', sans-serif;
Â Â font-weight: 900;
Â Â font-size: 2.7em;
Â Â letter-spacing: 2.5px;
Â Â color: #0080FF;
Â Â text-shadow:
Â Â Â Â 0 1px 8px #bfe2ffcc,
Â Â Â Â 0 0 4px #0080FF22;
Â Â animation: blueGrowFlash 1.3s cubic-bezier(.65,.13,.31,1.06) infinite alternate;
Â Â transition: color 0.2s, transform 0.2s;
}
@keyframes blue-bg-flash {
Â Â 0% {
Â Â Â Â background: linear-gradient(120deg, #e3f2fd 0%, #c8e6fa 80%, #bbdefb 100%);
Â Â Â Â filter: brightness(1) blur(0.1px);
Â Â }
Â Â 35% {
Â Â Â Â background: linear-gradient(120deg, #d2ecfa 5%, #b3e6fb 60%, #b6ccf2 100%);
Â Â Â Â filter: brightness(1.06) blur(0.25px);
Â Â }
Â Â 60% {
Â Â Â Â background: linear-gradient(120deg, #caeafc 0%, #e0f4fc 80%, #b3d8f5 100%);
Â Â Â Â filter: brightness(1.09) blur(0.4px);
Â Â }
Â Â 100% {
Â Â Â Â background: linear-gradient(120deg, #e3f2fd 0%, #c8e6fa 80%, #bbdefb 100%);
Â Â Â Â filter: brightness(1) blur(0.1px);
Â Â }
}
.lottery-final-bg-blue {
Â Â animation: blue-bg-flash 2.8s cubic-bezier(.75,.13,.19,.95) infinite alternate;
Â Â background: linear-gradient(120deg, #e3f2fd 0%, #c8e6fa 80%, #bbdefb 100%) !important;
}
.selected-mode-tag:empty {
Â Â display: none;
}
#resultArea canvas {
Â Â max-width: 100%;
Â Â height: auto !important;
Â Â display: block;
Â Â margin: auto;
}
</style>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
Â Â Â Â apiKey: "AIzaSyBUbKgC4P7wGFQqZZmgJU890qOe_4yC9kA",
Â Â Â Â authDomain: "choosehel.firebaseapp.com",
Â Â Â Â databaseURL: "https://choosehel-default-rtdb.asia-southeast1.firebasedatabase.app",
Â Â Â Â projectId: "choosehel",
Â Â Â Â storageBucket: "choosehel.appspot.com",
Â Â Â Â messagingSenderId: "116763876894",
Â Â Â Â appId: "1:116763876894:web:1662b36ef2fa815863d80f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let userId;
let hasShownReeditSuccess = false;
let hasShownConfirmModal = false;
let hasShownReeditModal = false;
let lastConfirmInitiator = null;
let lastReeditInitiator = null;

// Debug function to log messages to the appropriate debug box
function logDebug(message) {
Â Â Â Â const activePage = document.querySelector('.page.active');
Â Â Â Â let debugBox;
Â Â Â Â if (activePage.id === 'multiPage') {
Â Â Â Â Â Â Â Â debugBox = document.getElementById('multiDebugBox');
Â Â Â Â } else if (activePage.id === 'decidePage') {
Â Â Â Â Â Â Â Â debugBox = document.getElementById('decideDebugBox');
Â Â Â Â }
Â Â Â Â if (debugBox) {
Â Â Â Â Â Â Â Â debugBox.innerHTML += `<p>${new Date().toLocaleTimeString()} - ${message}</p>`;
Â Â Â Â Â Â Â Â debugBox.scrollTop = debugBox.scrollHeight;
Â Â Â Â }
}

// Debounce function to reduce repeated Firebase triggers
function debounce(func, wait) {
Â Â Â Â let timeout;
Â Â Â Â return function executedFunction(...args) {
Â Â Â Â Â Â Â Â const later = () => {
Â Â Â Â Â Â Â Â Â Â Â Â clearTimeout(timeout);
Â Â Â Â Â Â Â Â Â Â Â Â func(...args);
Â Â Â Â Â Â Â Â };
Â Â Â Â Â Â Â Â clearTimeout(timeout);
Â Â Â Â Â Â Â Â timeout = setTimeout(later, wait);
Â Â Â Â };
}

async function createRoom() {
Â Â Â Â logDebug("createRoom: Starting room creation");
Â Â Â Â const roomName = document.getElementById('roomNameInput').value.trim();
Â Â Â Â const verificationCodeInput = document.getElementById('verificationCodeInput').value.trim();
Â Â Â Â const userName = document.getElementById('userNameInput').value.trim();

Â Â Â Â if (!roomName || !userName) {
Â Â Â Â Â Â Â Â logDebug("createRoom: Missing roomName or userName");
Â Â Â Â Â Â Â Â showModal('è«‹è¼¸å…¥æˆ¿é–“åç¨±å’Œä½ çš„åç¨±', [
Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â return;
Â Â Â Â }

Â Â Â Â let verificationCode = verificationCodeInput || generateVerificationCode();
Â Â Â Â const roomIdRaw = `${roomName}-${verificationCode}`;
Â Â Â Â const roomId = encodeURIComponent(roomIdRaw);
Â Â Â Â const createBtn = document.querySelector('#setupPage .btn-primary');
Â Â Â Â createBtn.disabled = true;
Â Â Â Â createBtn.innerHTML = '<span class="spin-animation">â³</span> å»ºç«‹ä¸­...';
Â Â Â Â logDebug(`createRoom: Attempting to create/join room ${roomId}`);

Â Â Â Â userId = 'user_' + Math.random().toString(36).substr(2, 9);
Â Â Â Â localStorage.setItem(`currentUserId_${roomId}`, userId);
Â Â Â Â localStorage.setItem('currentRoomId', roomId);
Â Â Â Â logDebug(`createRoom: Generated userId ${userId} for user ${userName} in room ${roomId}`);

Â Â Â Â const roomRef = db.ref('rooms/' + roomId);
Â Â Â Â const maxRetries = 3;
Â Â Â Â let attempt = 0;

Â Â Â Â while (attempt < maxRetries) {
Â Â Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â Â Â Â Â const snapshot = await roomRef.child('participants').once('value');
Â Â Â Â Â Â Â Â Â Â Â Â const participants = snapshot.val() || {};
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`createRoom: Found ${Object.keys(participants).length} participants`);
Â Â Â Â Â Â Â Â Â Â Â Â if (Object.keys(participants).length === 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await roomRef.update({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â finalResult: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawResult: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â isDrawing: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â vote: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â confirm: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â editConfirm: null
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("createRoom: Initialized empty room");
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â await roomRef.update({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â name: roomName,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â code: verificationCode,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â creator: userNameÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â const participantRef = roomRef.child('participants/' + userId);
Â Â Â Â Â Â Â Â Â Â Â Â await participantRef.set({ name: userName, lastActive: Date.now() });
participantRef.onDisconnect().remove(); // â† å°±é€™ä¸€è¡Œ
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`createRoom: Added user ${userId} (${userName})`);

Â Â Â Â Â Â Â Â Â Â Â Â document.getElementById('setupPage').classList.remove('active');
Â Â Â Â Â Â Â Â Â Â Â Â document.getElementById('multiPage').classList.add('active');
Â Â Â Â Â Â Â Â Â Â Â Â document.getElementById('roomNameDisplay').textContent = `ğŸ ï¼š${roomName} `;
document.getElementById('roomCodeDisplay').textContent = `(ğŸ”‘ï¼š${verificationCode})`;

Â Â Â Â Â Â Â Â Â Â Â Â logDebug("createRoom: Switched to multiPage");
window.keepAliveTimer && clearInterval(window.keepAliveTimer);
window.keepAliveTimer = setInterval(() => {
Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â const userId = localStorage.getItem(`currentUserId_${roomId}`);
Â Â if (roomId && userId) {
Â Â Â Â db.ref(`rooms/${roomId}/participants/${userId}/lastActive`).set(Date.now());
Â Â }
}, 30000); // æ¯30ç§’

window.addEventListener('beforeunload', () => {
Â Â clearInterval(window.keepAliveTimer);
});
// â¬†â¬†â¬† åˆ°é€™è£¡ â¬†â¬†â¬†
Â Â Â Â Â Â Â Â Â Â Â Â loadRoomData(roomId);
Â Â Â Â Â Â Â Â Â Â Â Â listenConfirmation(roomId);
Â Â Â Â Â Â Â Â Â Â Â Â listenVote(roomId);
Â Â Â Â Â Â Â Â Â Â Â Â listenReedit(roomId); // ç¢ºä¿é‡æ–°ç·¨è¼¯ç›£è½åœ¨æˆ¿é–“å‰µå»ºæ™‚å•Ÿå‹•
Â Â Â Â Â Â Â Â Â Â Â Â createBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â createBtn.innerHTML = 'å»ºç«‹ / åŠ å…¥';
Â Â Â Â Â Â Â Â Â Â Â Â logDebug("createRoom: Successfully created/joined room");
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â Â attempt++;
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`createRoom: Error on attempt ${attempt}: ${error.message}`);
Â Â Â Â Â Â Â Â Â Â Â Â if (attempt === maxRetries) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.error('createRoom: Firebase error after retries:', error);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal('æˆ¿é–“å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â createBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â createBtn.innerHTML = 'å»ºç«‹ / åŠ å…¥';
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â await new Promise(resolve => setTimeout(resolve, 1000));
Â Â Â Â Â Â Â Â }
Â Â Â Â }
}

function showModal(content, buttons, modalId = 'generic') {
Â Â Â Â if (document.querySelector(`.modal[data-modalId="${modalId}"]`)) {
Â Â Â Â Â Â Â Â logDebug(`showModal: Modal ${modalId} already exists, skipping`);
Â Â Â Â Â Â Â Â return;
Â Â Â Â }
Â Â Â Â closeModalById(modalId);
Â Â Â Â const modal = document.createElement('div');
Â Â Â Â modal.className = 'modal';
Â Â Â Â modal.dataset.modalId = modalId;
Â Â Â Â const modalContent = document.createElement('div');
Â Â Â Â modalContent.className = 'modal-content';
Â Â Â Â modalContent.innerHTML = `<p style="font-size:18px;">${content}</p>`;
Â Â Â Â buttons.forEach(btn => {
Â Â Â Â Â Â Â Â const button = document.createElement('button');
Â Â Â Â Â Â Â Â button.className = btn.class || 'btn-primary';
Â Â Â Â Â Â Â Â button.textContent = btn.text;
Â Â Â Â Â Â Â Â button.onclick = () => {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`showModal: Button clicked - ${btn.text} for modal ${modalId}`);
Â Â Â Â Â Â Â Â Â Â Â Â modal.remove();
Â Â Â Â Â Â Â Â Â Â Â Â btn.onClick();
Â Â Â Â Â Â Â Â };
Â Â Â Â Â Â Â Â modalContent.appendChild(button);
Â Â Â Â });
Â Â Â Â modal.appendChild(modalContent);
Â Â Â Â document.body.appendChild(modal);
Â Â Â Â logDebug(`showModal: Displayed modal ${modalId} with content: ${content}`);
}

function closeModalById(modalId) {
Â Â Â Â const modal = document.querySelector(`.modal[data-modalId="${modalId}"]`);
Â Â Â Â if (modal) {
Â Â Â Â Â Â Â Â modal.remove();
Â Â Â Â Â Â Â Â logDebug(`closeModalById: Closed modal ${modalId}`);
Â Â Â Â }
}

function closeAllModals() {
Â Â Â Â document.querySelectorAll('.modal').forEach(modal => {
Â Â Â Â Â Â Â Â logDebug(`closeAllModals: Closing modal ${modal.dataset.modalId}`);
Â Â Â Â Â Â Â Â modal.remove();
Â Â Â Â });
}

function loadRoomData(roomId) {
Â Â Â Â logDebug("loadRoomData: Loading room data");
Â Â Â Â Â // â¬‡â¬‡â¬‡ åŠ åœ¨é€™è£¡ï¼ˆåªè¦é€²æˆ¿å°±ä¸€å®šæœƒæƒæï¼‰ â¬‡â¬‡â¬‡
Â Â Â Â window.inactiveCleanupTimer && clearInterval(window.inactiveCleanupTimer);
Â Â Â Â window.inactiveCleanupTimer = setInterval(() => {
Â Â Â Â Â Â if (!roomId) return;
Â Â Â Â Â Â db.ref(`rooms/${roomId}/participants`).once('value').then(snap => {
Â Â Â Â Â Â Â Â const now = Date.now();
Â Â Â Â Â Â Â Â const users = snap.val() || {};
Â Â Â Â Â Â Â Â Object.entries(users).forEach(([uid, obj]) => {
Â Â Â Â Â Â Â Â Â Â if (obj.lastActive && now - obj.lastActive > 5*60*1000) { // 2åˆ†é˜
Â Â Â Â Â Â Â Â Â Â Â Â db.ref(`rooms/${roomId}/participants/${uid}`).remove();
Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â });
Â Â Â Â }, 30000);

Â Â Â Â window.addEventListener('beforeunload', () => {
Â Â Â Â Â Â clearInterval(window.inactiveCleanupTimer);
Â Â Â Â });
Â Â Â Â // â¬†â¬†â¬† åˆ°é€™è£¡ â¬†â¬†â¬†
Â Â Â Â const roomRef = db.ref('rooms/' + roomId);
Â Â Â Â const participantContainer = document.getElementById('participantContainer');
Â Â Â Â const listContainer = document.getElementById('listContainer');

Â Â Â Â roomRef.child('isDrawing').on('value', snap => {
Â Â Â Â Â Â Â Â const isDrawing = snap.val();
Â Â Â Â Â Â Â Â logDebug(`loadRoomData: isDrawing changed to ${isDrawing}`);
Â Â Â Â Â Â Â Â if (isDrawing) {
Â Â Â Â Â Â Â Â Â Â Â Â playDrawAnimation(roomId);
Â Â Â Â Â Â Â Â }
Â Â Â Â });

// ä½ çš„åŸæœ¬ç›£è½ isDrawing
roomRef.child('isDrawing').on('value', snap => {
Â Â Â Â const isDrawing = snap.val();
Â Â Â Â logDebug(`loadRoomData: isDrawing changed to ${isDrawing}`);
Â Â Â Â // æ§åˆ¶æŠ½ç±¤æŒ‰éˆ•
Â Â Â Â const drawBtn = document.querySelector('#decidePage .btn-draw');
Â Â Â Â if (drawBtn) drawBtn.disabled = !!isDrawing;

Â Â Â Â if (isDrawing) {
Â Â Â Â Â Â Â Â playDrawAnimation(roomId);
Â Â Â Â }
});

// ä½ çš„åŸæœ¬ç›£è½ finalResult
roomRef.child('finalResult').on('value', snap => {
Â Â Â Â const result = snap.val();
Â Â Â Â logDebug(`loadRoomData: finalResult changed to ${result}`);
Â Â Â Â // æ§åˆ¶æŠ½ç±¤æŒ‰éˆ•
Â Â Â Â const drawBtn = document.querySelector('#decidePage .btn-draw');
Â Â Â Â if (drawBtn) drawBtn.disabled = !!result; // çµæœæœ‰å€¼ä¹Ÿç¦ç”¨

Â Â Â Â if (result) {
Â Â Â Â Â Â Â Â if (!document.getElementById('decidePage').classList.contains('active')) {
Â Â Â Â Â Â Â Â Â Â Â Â document.getElementById('multiPage').classList.remove('active');
Â Â Â Â Â Â Â Â Â Â Â Â document.getElementById('decidePage').classList.add('active');
Â Â Â Â Â Â Â Â Â Â Â Â document.getElementById('resultArea').innerHTML = '';
Â Â Â Â const drawBtn = document.querySelector('#decidePage .btn-draw');
Â Â Â Â if (drawBtn) drawBtn.style.display = '';
Â Â Â Â const modeBtn = document.querySelector('#decidePage .btn-primary[onclick="chooseDecisionMode()"]');
Â Â Â Â if (modeBtn) modeBtn.style.display = '';
Â Â Â Â logDebug("loadRoomData: Switched to decidePage due to finalResult");
}
Â Â Â Â Â Â Â Â setTimeout(() => {
Â Â Â Â Â Â Â Â Â Â Â Â showFinalResult(result);
Â Â Â Â Â Â Â Â }, 150);
Â Â Â Â }
});


Â Â Â Â roomRef.child('participants').on('value', snapshot => {
Â Â Â Â Â Â Â Â const data = snapshot.val() || {};
Â Â Â Â Â Â Â Â logDebug(`loadRoomData: Participants updated, count: ${Object.keys(data).length}`);
Â Â Â Â Â Â Â Â participantContainer.innerHTML = '';
Â Â Â Â Â Â Â Â const participantCountDisplay = document.getElementById('participantCount');
Â Â Â Â Â Â Â Â if (participantCountDisplay) {
Â Â Â Â Â Â Â Â Â Â Â Â participantCountDisplay.textContent = `åƒèˆ‡è€…(${Object.keys(data).length}äºº)ï¼š`;
Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â const decideParticipantContainer = document.getElementById('decideParticipantContainer');
Â Â Â Â Â Â Â Â const decideParticipantCountDisplay = document.getElementById('decideParticipantCount');
Â Â Â Â Â Â Â Â if (decideParticipantContainer) decideParticipantContainer.innerHTML = '';
Â Â Â Â Â Â Â Â if (decideParticipantCountDisplay) {
Â Â Â Â Â Â Â Â Â Â Â Â decideParticipantCountDisplay.textContent = `åƒèˆ‡è€…(${Object.keys(data).length}äºº)ï¼š`;
Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Object.values(data).forEach(p => {
Â Â Â Â Â Â Â Â Â Â Â Â const div = document.createElement('div');
Â Â Â Â Â Â Â Â Â Â Â Â div.className = 'item-box';
Â Â Â Â Â Â Â Â Â Â Â Â div.textContent = p.name;
Â Â Â Â Â Â Â Â Â Â Â Â participantContainer.appendChild(div);

Â Â Â Â Â Â Â Â Â Â Â Â if (decideParticipantContainer) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const divClone = div.cloneNode(true);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â decideParticipantContainer.appendChild(divClone);
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â });
Â Â Â Â });

Â Â Â Â roomRef.child('list').on('value', snapshot => {
Â Â Â Â Â Â Â Â const items = snapshot.val() || [];
Â Â Â Â Â Â Â Â logDebug(`loadRoomData: List updated, items: ${items.length}`);
Â Â Â Â Â Â Â Â listContainer.innerHTML = '';
Â Â Â Â Â Â Â Â items.forEach((item, index) => {
Â Â Â Â Â Â Â Â Â Â Â Â const div = document.createElement('div');
Â Â Â Â Â Â Â Â Â Â Â Â div.className = 'item-box';
Â Â Â Â Â Â Â Â Â Â Â Â const span = document.createElement('span');
Â Â Â Â Â Â Â Â Â Â Â Â span.textContent = item;
Â Â Â Â Â Â Â Â Â Â Â Â const btn = document.createElement('button');
Â Â Â Â Â Â Â Â Â Â Â Â btn.textContent = 'âœ•';
Â Â Â Â Â Â Â Â Â Â Â Â btn.className = 'remove-btn';
Â Â Â Â Â Â Â Â Â Â Â Â btn.onclick = () => removeItem(index);
Â Â Â Â Â Â Â Â Â Â Â Â div.appendChild(span);
Â Â Â Â Â Â Â Â Â Â Â Â div.appendChild(btn);
Â Â Â Â Â Â Â Â Â Â Â Â listContainer.appendChild(div);
Â Â Â Â Â Â Â Â });
Â Â Â Â });

Â Â Â Â roomRef.child('decisionMode').on('value', snapshot => {
Â Â Â Â Â Â Â Â const mode = snapshot.val() || '';
Â Â Â Â Â Â Â Â logDebug(`loadRoomData: Decision mode changed to ${mode}`);
Â Â Â Â Â Â Â Â document.getElementById('selectedMode').textContent = mode ? `ã€${mode}ã€‘` : '';

Â Â Â Â Â Â Â Â const decideModeDisplay = document.getElementById('decideModeDisplay');
Â Â Â Â Â Â Â Â if (decideModeDisplay) decideModeDisplay.textContent = mode ? `ã€${mode}ã€‘` : '';
Â Â Â Â });

Â Â Â Â roomRef.child('name').once('value').then(nameSnap => {
Â Â Â Â const roomName = nameSnap.val() || '';
Â Â Â Â roomRef.child('code').once('value').then(codeSnap => {
Â Â Â Â Â Â Â Â const verificationCode = codeSnap.val() || '';
Â Â Â Â Â Â Â Â const decideRoomNameDisplay = document.getElementById('decideRoomNameDisplay');
Â Â Â Â Â Â Â Â const decideRoomCodeDisplay = document.getElementById('decideRoomCodeDisplay');
Â Â Â Â Â Â Â Â if (decideRoomNameDisplay) decideRoomNameDisplay.textContent = `ğŸ ï¼š${roomName}`;
Â Â Â Â Â Â Â Â if (decideRoomCodeDisplay) decideRoomCodeDisplay.textContent = `(ğŸ”‘ï¼š${verificationCode})`;
Â Â Â Â Â Â Â Â logDebug(`loadRoomData: Room name set to ${roomName}, code: ${verificationCode}`);
Â Â Â Â });
});


roomRef.child('isDeciding').on('value', snap => {
Â Â Â Â const isDeciding = snap.val();
Â Â Â Â logDebug(`loadRoomData: isDeciding changed to ${isDeciding}`);
Â Â Â Â const decidePage = document.getElementById('decidePage');
Â Â Â Â const multiPage = document.getElementById('multiPage');
Â Â Â Â const confirmRef = db.ref(`rooms/${roomId}/confirm`);
Â Â Â Â const reeditRef = db.ref(`rooms/${roomId}/editConfirm`);

Â Â Â Â if (isDeciding && !decidePage.classList.contains('active')) {
Â Â Â Â Â Â Â Â logDebug("loadRoomData: Switching to decidePage");
Â Â Â Â Â Â Â Â multiPage.classList.remove('active');
Â Â Â Â Â Â Â Â decidePage.classList.add('active');
Â Â Â Â Â Â Â Â confirmRef.off('value');
Â Â Â Â Â Â Â Â confirmRef.remove();
Â Â Â Â Â Â Â Â listenReedit(roomId);
Â Â Â Â Â Â Â Â listenVote(roomId);
// =======ã€åŠ åœ¨é€™è£¡ã€‘=======
Â Â Â Â // åªè¦é€²å…¥ decidePageï¼Œå¦‚æœæ²’æœ‰ finalResultï¼Œæ¢å¾©æŒ‰éˆ•å’Œæ¸…çç‹€
Â Â Â Â db.ref(`rooms/${roomId}/finalResult`).once('value').then(snap => {
Â Â Â Â Â Â Â Â if (!snap.val()) {
Â Â Â Â Â Â Â Â Â Â Â Â const drawBtn = document.querySelector('#decidePage .btn-draw');
Â Â Â Â Â Â Â Â Â Â Â Â if (drawBtn) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawBtn.style.display = '';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â const modeBtn = document.querySelector('#decidePage .btn-primary[onclick="chooseDecisionMode()"]');
Â Â Â Â Â Â Â Â Â Â Â Â if (modeBtn) modeBtn.style.display = '';
document.getElementById('decideModeDisplay').style.display = '';
Â Â Â Â Â Â Â Â Â Â Â Â document.getElementById('resultArea').innerHTML = '';
Â Â Â Â Â Â Â Â }
Â Â Â Â });
Â Â Â Â // =========================
Â Â Â Â } else if (!isDeciding && !multiPage.classList.contains('active')) {
Â Â Â Â Â Â Â Â logDebug("loadRoomData: Switching to multiPage");
Â Â Â Â Â Â Â Â decidePage.classList.remove('active');
Â Â Â Â Â Â Â Â multiPage.classList.add('active');
Â Â Â Â Â Â Â Â reeditRef.off('value');
Â Â Â Â Â Â Â Â reeditRef.remove();
Â Â Â Â Â Â Â Â confirmRef.remove();
Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â listenConfirmation(roomId);
Â Â Â Â } else if (isDeciding) {
Â Â Â Â Â Â Â Â listenReedit(roomId);
Â Â Â Â Â Â Â Â listenVote(roomId);
Â Â Â Â }
});

}

async function addItem() {
Â Â Â Â logDebug("addItem: Starting item addition");
Â Â Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â Â Â const input = document.getElementById('itemInput');
Â Â Â Â const value = input.value.trim();
Â Â Â Â if (!value) {
Â Â Â Â Â Â Â Â logDebug("addItem: Empty input, aborting");
Â Â Â Â Â Â Â Â return;
Â Â Â Â }

Â Â Â Â const addBtn = document.querySelector('#multiPage .btn-primary[onclick="addItem()"]');
Â Â Â Â addBtn.disabled = true;
Â Â Â Â addBtn.innerHTML = '<span class="spin-animation">â³</span> æ–°å¢ä¸­...';
Â Â Â Â logDebug("addItem: Button disabled, adding item");

Â Â Â Â const listRef = db.ref('rooms/' + roomId + '/list');
Â Â Â Â const maxRetries = 3;
Â Â Â Â let attempt = 0;

Â Â Â Â while (attempt < maxRetries) {
Â Â Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â Â Â Â Â const snapshot = await listRef.once('value');
Â Â Â Â Â Â Â Â Â Â Â Â let list = snapshot.val() || [];
Â Â Â Â Â Â Â Â Â Â Â Â list.push(value);
Â Â Â Â Â Â Â Â Â Â Â Â await listRef.set(list);
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`addItem: Added item ${value} to list`);
Â Â Â Â Â Â Â Â Â Â Â Â input.value = '';
Â Â Â Â Â Â Â Â Â Â Â Â addBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â addBtn.innerHTML = 'æ–°å¢é …ç›®';
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â Â attempt++;
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`addItem: Error on attempt ${attempt}: ${error.message}`);
Â Â Â Â Â Â Â Â Â Â Â Â if (attempt === maxRetries) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.error('addItem: Firebase error after retries:', error);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal('æ–°å¢é …ç›®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â addBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â addBtn.innerHTML = 'æ–°å¢é …ç›®';
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â await new Promise(resolve => setTimeout(resolve, 1000));
Â Â Â Â Â Â Â Â }
Â Â Â Â }
}

async function removeItem(index) {
Â Â Â Â logDebug(`removeItem: Attempting to remove item at index ${index}`);
Â Â Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â Â Â const listRef = db.ref('rooms/' + roomId + '/list');
Â Â Â Â const maxRetries = 3;
Â Â Â Â let attempt = 0;

Â Â Â Â while (attempt < maxRetries) {
Â Â Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â Â Â Â Â const snapshot = await listRef.once('value');
Â Â Â Â Â Â Â Â Â Â Â Â let list = snapshot.val() || [];
Â Â Â Â Â Â Â Â Â Â Â Â list.splice(index, 1);
Â Â Â Â Â Â Â Â Â Â Â Â await listRef.set(list);
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`removeItem: Removed item at index ${index}`);
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â Â attempt++;
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`removeItem: Error on attempt ${attempt}: ${error.message}`);
Â Â Â Â Â Â Â Â Â Â Â Â if (attempt === maxRetries) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.error('removeItem: Firebase error after retries:', error);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal('ç§»é™¤é …ç›®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â await new Promise(resolve => setTimeout(resolve, 1000));
Â Â Â Â Â Â Â Â }
Â Â Â Â }
}

function shareRoom() {
Â Â Â Â logDebug("shareRoom: Initiating room sharing");
Â Â Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â Â Â const roomRef = db.ref(`rooms/${roomId}`);

Â Â Â Â roomRef.once('value').then(snapshot => {
Â Â Â Â Â Â Â Â const data = snapshot.val() || {};
Â Â Â Â Â Â Â Â const roomName = data.name || '';
Â Â Â Â Â Â Â Â const verificationCode = data.code || '';
Â Â Â Â Â Â Â Â const url = `${location.origin}${location.pathname}?room=${encodeURIComponent(roomName)}&code=${encodeURIComponent(verificationCode)}`;
Â Â Â Â Â Â Â Â logDebug(`shareRoom: Generated share URL: ${url}`);

Â Â Â Â Â Â Â Â showModal('è«‹é¸æ“‡åˆ†äº«æ–¹å¼', [
Â Â Â Â Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: 'ğŸŒ åˆ†äº«',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-primary',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onClick: () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("shareRoom: Share button clicked");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (navigator.share) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â navigator.share({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â title: `åŠ å…¥æˆ‘çš„é¸æ“‡æˆ¿é–“ - ${roomName}`,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: 'é»æ“Šå¿«é€ŸåŠ å…¥æˆ¿é–“ï¼',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â url
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }).catch(err => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`shareRoom: Share failed: ${err.message}`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal('åˆ†äº«å¤±æ•—: ' + err, [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("shareRoom: Device does not support sharing");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal('æ­¤è£ç½®ä¸æ”¯æ´ç›´æ¥åˆ†äº«åŠŸèƒ½', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: 'ğŸ“‹ è¤‡è£½',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-primary',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onClick: () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("shareRoom: Copy link button clicked");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â navigator.clipboard.writeText(url)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .then(() => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("shareRoom: Link copied successfully");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal('å·²è¤‡è£½é€£çµï¼Œå¯ç›´æ¥è²¼çµ¦æœ‹å‹ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'success');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â })
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .catch(err => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`shareRoom: Copy failed: ${err.message}`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: 'â¨‰',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-confirm',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onClick: () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("shareRoom: Cancel button clicked");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â ], 'share');
Â Â Â Â });
}

function listenConfirmation(roomId) {
Â Â Â Â logDebug("listenConfirmation: Starting confirmation listener");
Â Â Â Â const confirmRef = db.ref(`rooms/${roomId}/confirm`);
Â Â Â Â const modalId = 'confirm';
Â Â Â Â let lastProcessedData = null;

Â Â Â Â confirmRef.on('value', debounce(async snapshot => {
Â Â Â Â Â Â Â Â const data = snapshot.val();
Â Â Â Â Â Â Â Â const dataString = JSON.stringify(data);
Â Â Â Â Â Â Â Â if (dataString === lastProcessedData) {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenConfirmation: Data unchanged, skipping");
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â closeModalById(modalId); // æå‰é—œé–‰æ¨¡æ…‹æ¡†
Â Â Â Â Â Â Â Â lastProcessedData = dataString;
Â Â Â Â Â Â Â Â logDebug(`listenConfirmation: Received data: ${dataString}, User: ${userId}`);

Â Â Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â Â Â Â Â const roomSnap = await db.ref(`rooms/${roomId}`).once('value');
Â Â Â Â Â Â Â Â Â Â Â Â const roomData = roomSnap.val() || {};
Â Â Â Â Â Â Â Â Â Â Â Â const isDeciding = roomData.isDeciding;
Â Â Â Â Â Â Â Â Â Â Â Â const hasFinalResult = !!roomData.finalResult;
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`listenConfirmation: Room state - isDeciding: ${isDeciding}, hasFinalResult: ${hasFinalResult}`);

Â Â Â Â Â Â Â Â Â Â Â Â if (isDeciding || hasFinalResult) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenConfirmation: Terminating due to isDeciding or finalResult");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await confirmRef.remove();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â confirmRef.off('value');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._confirmCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (!data) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenConfirmation: No data, skip showing cancel modal");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._confirmCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (!data.active || data.status === 'cancelled') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenConfirmation: Confirmation cancelled or inactive");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._confirmCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const cancelledByName = data.cancelledBy ? (await db.ref(`rooms/${roomId}/participants/${data.cancelledBy}`).once('value')).val()?.name || 'æœªçŸ¥ç”¨æˆ¶' : 'æœªçŸ¥ç”¨æˆ¶';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal(`âŒ ç¢ºèªæµç¨‹å·²è¢« ${cancelledByName} å–æ¶ˆã€‚`, [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await confirmRef.remove();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (data.status !== 'pending') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenConfirmation: Not pending, cleaning up");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeModalById(modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._confirmCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (!data.initiator || !data.initiatorName) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenConfirmation: Invalid initiator data, ignoring");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await confirmRef.remove();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeModalById(modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._confirmCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal('âŒ ç¢ºèªæµç¨‹ç„¡æ•ˆï¼Œå·²å–æ¶ˆã€‚', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â const participantSnap = await db.ref(`rooms/${roomId}/participants`).once('value');
Â Â Â Â Â Â Â Â Â Â Â Â const participants = participantSnap.val() || {};
Â Â Â Â Â Â Â Â Â Â Â Â const total = Object.keys(participants).length;
Â Â Â Â Â Â Â Â Â Â Â Â const responses = data.responses || {};
Â Â Â Â Â Â Â Â Â Â Â Â const agreeCount = Object.values(responses).filter(v => v === true).length;
Â Â Â Â Â Â Â Â Â Â Â Â const disagreeCount = Object.values(responses).filter(v => v === false).length;

Â Â Â Â Â Â Â Â Â Â Â Â await confirmRef.update({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â agreeCount: agreeCount,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â disagreeCount: disagreeCount
Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`listenConfirmation: Updated counts - Agree: ${agreeCount}, Disagree: ${disagreeCount}`);

Â Â Â Â Â Â Â Â Â Â Â Â const progressText = `ï¼ˆç›®å‰ ${agreeCount} äººåŒæ„ï¼Œ${disagreeCount} äººä¸åŒæ„ï¼‰`;

Â Â Â Â Â Â Â Â Â Â Â Â if (disagreeCount > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenConfirmation: Someone disagreed, cancelling");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await confirmRef.update({ status: 'cancelled', active: false });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._confirmCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal(`âŒ æœ‰äººä¸åŒæ„æ¸…å–®<br>ï¼ˆ${agreeCount} åŒæ„ï¼Œ${disagreeCount} ä¸åŒæ„ï¼‰ï¼Œæµç¨‹å·²å–æ¶ˆã€‚`, [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await confirmRef.remove();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (agreeCount === total && total > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenConfirmation: All agreed, switching to decidePage");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await confirmRef.update({ status: 'completed', active: false });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await db.ref(`rooms/${roomId}/isDeciding`).set(true);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._confirmCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const multiPage = document.getElementById('multiPage');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const decidePage = document.getElementById('decidePage');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (!decidePage.classList.contains('active')) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenConfirmation: Forcing switch to decidePage");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â multiPage.classList.remove('active');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â decidePage.classList.add('active');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal('âœ… æ‰€æœ‰äººåŒæ„ï¼Œé€²å…¥æŠ½ç±¤é é¢ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'success');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (responses[userId] === true) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenConfirmation: User has agreed, showing waiting modal");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showWaitingModal(confirmRef, userId, `å·²åŒæ„ï¼Œç­‰å¾…å…¶ä»–äººåŒæ„ä¸­... <br>${progressText}`, modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._confirmCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenConfirmation: Showing confirmation modal for user");
Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â showModal(`å·²ç™¼èµ·æ¸…å–®ç¢ºèªï¼Œæ˜¯å¦åŒæ„ï¼Ÿ<br>${progressText}`, [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: 'åŒæ„',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-confirm',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onClick: async () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â clearTimeout(window._confirmTimeout);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._confirmCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenConfirmation: User agrees");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await confirmRef.child('responses').child(userId).set(true);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showWaitingModal(confirmRef, userId, `å·²åŒæ„ï¼Œç­‰å¾…å…¶ä»–äººåŒæ„ä¸­...<br> ${progressText}`, modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: 'ä¸åŒæ„',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-primary',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onClick: async () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â clearTimeout(window._confirmTimeout);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._confirmCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenConfirmation: User disagrees");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await confirmRef.child('responses').child(userId).set(false);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â ], modalId);

Â Â Â Â Â Â Â Â Â Â Â Â // ===== å€’æ•¸å‹•ç•« + è‡ªå‹•åŒæ„ï¼Œ**ç¬¬ä¸€æ¬¡å½ˆçª—æ‰è¨­ startTime** =====
Â Â Â Â Â Â Â Â Â Â Â Â if (!window._confirmCountdownStartTime) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._confirmCountdownStartTime = Date.now();
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â showVoteCountdown(25, window._confirmCountdownStartTime);
Â Â Â Â Â Â Â Â Â Â Â Â clearTimeout(window._confirmTimeout);
Â Â Â Â Â Â Â Â Â Â Â Â let remain = 25 - Math.floor((Date.now() - window._confirmCountdownStartTime) / 1000);
Â Â Â Â Â Â Â Â Â Â Â Â if (remain < 0) remain = 0;
Â Â Â Â Â Â Â Â Â Â Â Â window._confirmTimeout = setTimeout(async () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeModalById(modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._confirmCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await confirmRef.child('responses').child(userId).set(true);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showWaitingModal(confirmRef, userId, `ï¼ˆå·²è‡ªå‹•åŒæ„ï¼‰ç­‰å¾…å…¶ä»–äººåŒæ„ä¸­... <br>${progressText}`, modalId);
Â Â Â Â Â Â Â Â Â Â Â Â }, remain * 1000);

Â Â Â Â Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`listenConfirmation: Error: ${error.message}`);
Â Â Â Â Â Â Â Â Â Â Â Â window._confirmCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â showModal('è™•ç†ç¢ºèªæµç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â }
Â Â Â Â }, 500));
}


async function requestConfirmation() {
Â Â Â Â logDebug("requestConfirmation: Starting confirmation request");
Â Â Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â Â Â const userId = localStorage.getItem(`currentUserId_${roomId}`);
Â Â Â Â if (!userId) {
Â Â Â Â Â Â Â Â logDebug("requestConfirmation: No userId found in localStorage");
Â Â Â Â Â Â Â Â showModal('ç”¨æˆ¶èº«ä»½é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°åŠ å…¥æˆ¿é–“ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => { window.location.reload(); } }
Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â return;
Â Â Â Â }
Â Â Â Â logDebug(`requestConfirmation: Current userId: ${userId}`);
Â Â Â Â const confirmRef = db.ref(`rooms/${roomId}/confirm`);
Â Â Â Â const confirmBtn = document.querySelector('.btn-confirm-red');
Â Â Â Â confirmBtn.disabled = true;
Â Â Â Â confirmBtn.innerHTML = '<span class="spin-animation">â³</span> æäº¤ä¸­...';
Â Â Â Â logDebug("requestConfirmation: Button disabled, initiating request");

Â Â Â Â try {
Â Â Â Â Â Â Â Â const modeSnap = await db.ref(`rooms/${roomId}/decisionMode`).once('value');
Â Â Â Â Â Â Â Â const mode = modeSnap.val();
Â Â Â Â Â Â Â Â if (!mode) {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug("requestConfirmation: No decision mode selected");
Â Â Â Â Â Â Â Â Â Â Â Â showModal('è«‹å…ˆé¸æ“‡æ±ºå®šæ–¹å¼ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â confirmBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â confirmBtn.innerHTML = 'æˆ‘åŒæ„æ­¤æ¸…å–®';
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â const isDecidingSnap = await db.ref(`rooms/${roomId}/isDeciding`).once('value');
Â Â Â Â Â Â Â Â if (isDecidingSnap.exists() && isDecidingSnap.val() === true) {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug("requestConfirmation: Room is already deciding");
Â Â Â Â Â Â Â Â Â Â Â Â showModal('æˆ¿é–“æ­£åœ¨é€²è¡Œæ±ºå®šä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â confirmBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â confirmBtn.innerHTML = 'æˆ‘åŒæ„æ­¤æ¸…å–®';
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â const participantSnap = await db.ref(`rooms/${roomId}/participants/${userId}`).once('value');
Â Â Â Â Â Â Â Â if (!participantSnap.exists()) {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug("requestConfirmation: UserId not found in participants");
Â Â Â Â Â Â Â Â Â Â Â Â showModal('ç”¨æˆ¶èº«ä»½ç„¡æ•ˆï¼Œè«‹é‡æ–°åŠ å…¥æˆ¿é–“ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => { window.location.reload(); } }
Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â confirmBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â confirmBtn.innerHTML = 'æˆ‘åŒæ„æ­¤æ¸…å–®';
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â await confirmRef.transaction(currentData => {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug("requestConfirmation: Clearing confirm data via transaction");
Â Â Â Â Â Â Â Â Â Â Â Â return null;
Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â const userName = participantSnap.val().name || 'æœªçŸ¥';
Â Â Â Â Â Â Â Â await confirmRef.set({
Â Â Â Â Â Â Â Â Â Â Â Â active: true,
Â Â Â Â Â Â Â Â Â Â Â Â initiator: userId,
Â Â Â Â Â Â Â Â Â Â Â Â initiatorName: userName,
Â Â Â Â Â Â Â Â Â Â Â Â status: 'pending',
Â Â Â Â Â Â Â Â Â Â Â Â responses: {},
Â Â Â Â Â Â Â Â Â Â Â Â agreeCount: 0,Â  Â  // æ–°å¢ï¼šåˆå§‹åŒ–åŒæ„ç¥¨æ•¸
Â Â Â Â Â Â Â Â Â Â Â Â disagreeCount: 0, // æ–°å¢ï¼šåˆå§‹åŒ–ä¸åŒæ„ç¥¨æ•¸
Â Â Â Â Â Â Â Â Â Â Â Â timestamp: firebase.database.ServerValue.TIMESTAMP
Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â logDebug(`requestConfirmation: Set confirm data for initiator ${userName} (${userId})`);
Â Â Â Â Â Â Â Â showWaitingModal(confirmRef, userId, 'å·²ç™¼èµ·æ¸…å–®ç¢ºèªï¼Œç­‰å¾…æ‰€æœ‰äººåŒæ„...', 'confirm');
Â Â Â Â Â Â Â Â confirmBtn.disabled = false;
Â Â Â Â Â Â Â Â confirmBtn.innerHTML = 'æˆ‘åŒæ„æ­¤æ¸…å–®';
Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â logDebug(`requestConfirmation: Firebase error: ${error.message}`);
Â Â Â Â Â Â Â Â console.error('requestConfirmation: Firebase è¨­å®šéŒ¯èª¤:', error);
Â Â Â Â Â Â Â Â showModal('ç¢ºèªæµç¨‹å•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â confirmBtn.disabled = false;
Â Â Â Â Â Â Â Â confirmBtn.innerHTML = 'æˆ‘åŒæ„æ­¤æ¸…å–®';
Â Â Â Â }
}

function showWaitingModal(ref, userId, message, modalId) {
Â Â Â Â logDebug(`showWaitingModal: Displaying waiting modal ${modalId}`);
Â Â Â Â showModal(message, [
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â text: 'å–æ¶ˆ',
Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-primary',
Â Â Â Â Â Â Â Â Â Â Â Â onClick: async () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`showWaitingModal: Cancel button clicked for ${modalId} by user ${userId}`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await ref.update({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â status: 'cancelled',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â active: false,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â cancelledBy: userId,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â timestamp: firebase.database.ServerValue.TIMESTAMP
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`showWaitingModal: Set ${modalId} to cancelled state`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeModalById(modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`showWaitingModal: Error setting cancelled state: ${error.message}`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal('å–æ¶ˆæµç¨‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }
Â Â Â Â ], modalId);
}

async function startDraw() {
Â Â Â Â logDebug("startDraw: Starting draw process");
Â Â Â Â const drawBtn = document.querySelector('#decidePage .btn-draw');
Â Â Â Â drawBtn.disabled = true;
Â Â Â Â drawBtn.innerHTML = '<span class="spin-animation">â³</span> æª¢æŸ¥ä¸­...';
Â Â Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â Â Â const roomRef = db.ref(`rooms/${roomId}`);

Â Â Â Â try {
Â Â Â Â Â Â Â Â // â˜…â˜…â˜… 1. é˜²å‘†å¤šé‡æµç¨‹ç‹€æ…‹æª¢æŸ¥
Â Â Â Â Â Â Â Â // åªè¦æœ‰ä»»ä¸€æµç¨‹ï¼ˆfinalResultã€voteã€confirmã€editConfirmï¼‰é‚„æ²’çµæŸå°±ä¸èƒ½æŠ½
Â Â Â Â Â Â Â Â const [finalResultSnap, voteSnap, confirmSnap, editConfirmSnap, isDecidingSnap] = await Promise.all([
Â Â Â Â Â Â Â Â Â Â Â Â roomRef.child('finalResult').once('value'),
Â Â Â Â Â Â Â Â Â Â Â Â roomRef.child('vote').once('value'),
Â Â Â Â Â Â Â Â Â Â Â Â roomRef.child('confirm').once('value'),
Â Â Â Â Â Â Â Â Â Â Â Â roomRef.child('editConfirm').once('value'),
Â Â Â Â Â Â Â Â Â Â Â Â roomRef.child('isDeciding').once('value')
Â Â Â Â Â Â Â Â ]);
Â Â Â Â Â Â Â Â const hasFinalResult = !!finalResultSnap.val();
Â Â Â Â Â Â Â Â const hasActiveVote = !!(voteSnap.val() && voteSnap.val().active);
Â Â Â Â Â Â Â Â const hasActiveConfirm = !!(confirmSnap.val() && confirmSnap.val().active);
Â Â Â Â Â Â Â Â const hasActiveEdit = !!(editConfirmSnap.val() && editConfirmSnap.val().active);
Â Â Â Â Â Â Â Â const isDeciding = !!isDecidingSnap.val();

Â Â Â Â Â Â Â Â if (hasFinalResult || hasActiveVote || hasActiveConfirm || hasActiveEdit || !isDeciding) {
Â Â Â Â Â Â Â Â Â Â Â Â let reason = '';
Â Â Â Â Â Â Â Â Â Â Â Â if (hasFinalResult) reason = 'æœ¬æ¬¡çµæœå·²ç¶“ç”¢ç”Ÿï¼Œè«‹é‡æ–°ç·¨è¼¯æ¸…å–®ä»¥é€²è¡Œæ–°ä¸€è¼ªæŠ½ç±¤ï¼';
Â Â Â Â Â Â Â Â Â Â Â Â else if (hasActiveVote) reason = 'å°šæœ‰ä¸€è¼ªæŠ•ç¥¨æ­£åœ¨é€²è¡Œï¼Œè«‹å…ˆå®ŒæˆæŠ•ç¥¨æˆ–ç­‰å¾…æµç¨‹çµæŸã€‚';
Â Â Â Â Â Â Â Â Â Â Â Â else if (hasActiveConfirm) reason = 'æ¸…å–®ç¢ºèªæµç¨‹å°šæœªçµæŸï¼Œè«‹å…ˆå…¨éƒ¨åŒæ„æˆ–ç­‰å¾…æµç¨‹çµæŸã€‚';
Â Â Â Â Â Â Â Â Â Â Â Â else if (hasActiveEdit) reason = 'æœ‰ç·¨è¼¯ç¢ºèªæµç¨‹å°šæœªçµæŸï¼Œè«‹å…ˆå…¨éƒ¨åŒæ„æˆ–ç­‰å¾…æµç¨‹çµæŸã€‚';
Â Â Â Â Â Â Â Â Â Â Â Â else reason = 'ç›®å‰ä¸åœ¨æŠ½ç±¤æµç¨‹ç‹€æ…‹ï¼Œè«‹é‡æ–°ç¢ºèªï¼';

Â Â Â Â Â Â Â Â Â Â Â Â showModal(reason, [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â drawBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â drawBtn.innerHTML = 'ğŸ² é–‹å§‹æŠ½ç±¤';
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â // â˜…â˜…â˜… 2. å–å¾—æŠ½ç±¤é–
Â Â Â Â Â Â Â Â const txResult = await roomRef.child('isDrawing').transaction(current => {
Â Â Â Â Â Â Â Â Â Â Â Â if (current) return; // æœ‰äººæ­£åœ¨æŠ½ç±¤ï¼Œä¸å‹•
Â Â Â Â Â Â Â Â Â Â Â Â return userId; Â  Â  Â  // æŠŠ userId ç•¶æŠ½ç±¤é–
Â Â Â Â Â Â Â Â });

Â Â Â Â Â Â Â Â if (!txResult.committed) {
Â Â Â Â Â Â Â Â Â Â Â Â showModal('å·²æœ‰äººæ­£åœ¨æŠ½ç±¤ï¼Œè«‹ç­‰å¾…çµæœ...', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â ], 'info');
Â Â Â Â Â Â Â Â Â Â Â Â drawBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â drawBtn.innerHTML = 'ğŸ² é–‹å§‹æŠ½ç±¤';
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â // â˜…â˜…â˜… 3. é …ç›®æª¢æŸ¥èˆ‡æŠ½ç±¤
Â Â Â Â Â Â Â Â const [listSnap, modeSnap] = await Promise.all([
Â Â Â Â Â Â Â Â Â Â Â Â roomRef.child('list').once('value'),
Â Â Â Â Â Â Â Â Â Â Â Â roomRef.child('decisionMode').once('value')
Â Â Â Â Â Â Â Â ]);
Â Â Â Â Â Â Â Â const items = listSnap.val() || [];
Â Â Â Â Â Â Â Â const mode = modeSnap.val() || 'ä¸€æŠ½å…¥é­‚';
Â Â Â Â Â Â Â Â logDebug(`startDraw: Items count: ${items.length}, Mode: ${mode}`);

Â Â Â Â Â Â Â Â if (items.length === 0) {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug("startDraw: No items to draw");
Â Â Â Â Â Â Â Â Â Â Â Â showModal('âš ï¸ ç›®å‰æ²’æœ‰å¯æŠ½ç±¤çš„é …ç›®', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â await roomRef.child('isDrawing').set(null); // é‚„åŸé–
Â Â Â Â Â Â Â Â Â Â Â Â drawBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â drawBtn.innerHTML = 'ğŸ² é–‹å§‹æŠ½ç±¤';
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â // ç”¢ç”Ÿé …ç›®
Â Â Â Â Â Â Â Â const finalItem = items[Math.floor(Math.random() * items.length)];
Â Â Â Â Â Â Â Â const spinList = [];
Â Â Â Â Â Â Â Â for (let i = 0; i < 35; i++) {
Â Â Â Â Â Â Â Â Â Â Â Â spinList.push(items[Math.floor(Math.random() * items.length)]);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â spinList.push(finalItem);
Â Â Â Â Â Â Â Â logDebug(`startDraw: Generated spinList, finalItem: ${finalItem}`);

Â Â Â Â Â Â Â Â // è¨˜éŒ„çµæœ
Â Â Â Â Â Â Â Â await roomRef.update({
Â Â Â Â Â Â Â Â Â Â Â Â isDrawing: userId,
Â Â Â Â Â Â Â Â Â Â Â Â drawResult: finalItem,
Â Â Â Â Â Â Â Â Â Â Â Â drawAnimation: spinList,
Â Â Â Â Â Â Â Â Â Â Â Â vote: null // Clear vote data before draw
Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â logDebug("startDraw: Updated Firebase with draw data");
Â Â Â Â Â Â Â Â drawBtn.disabled = false;
Â Â Â Â Â Â Â Â drawBtn.innerHTML = 'ğŸ² é–‹å§‹æŠ½ç±¤';
Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â logDebug(`startDraw: Firebase error: ${error.message}`);
Â Â Â Â Â Â Â Â await db.ref(`rooms/${roomId}/isDrawing`).set(null); // éŒ¯èª¤è¦é‡‹æ”¾é–
Â Â Â Â Â Â Â Â showModal('æŠ½ç±¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â drawBtn.disabled = false;
Â Â Â Â Â Â Â Â drawBtn.innerHTML = 'ğŸ² é–‹å§‹æŠ½ç±¤';
Â Â Â Â }
}


function chooseDecisionMode() {
Â Â Â Â logDebug("chooseDecisionMode: Opening decision mode modal");
Â Â Â Â showModal('é¸æ“‡æ±ºå®šæ–¹å¼', [
Â Â Â Â Â Â Â Â { text: 'ä¸€æŠ½å…¥é­‚', onClick: () => setDecisionMode('ä¸€æŠ½å…¥é­‚') },
Â Â Â Â Â Â Â Â { text: 'å¤šæ•¸æ±º', onClick: () => setDecisionMode('å¤šæ•¸æ±º') },
Â Â Â Â Â Â Â Â { text: 'å…±è­˜æ±º', onClick: () => setDecisionMode('å…±è­˜æ±º') }
Â Â Â Â ], 'decisionMode');
}

async function setDecisionMode(mode) {
Â Â Â Â logDebug(`setDecisionMode: Setting mode to ${mode}`);
Â Â Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â Â Â try {
Â Â Â Â Â Â Â Â await db.ref(`rooms/${roomId}/decisionMode`).set(mode);
Â Â Â Â Â Â Â Â document.getElementById('selectedMode').textContent = `ã€${mode}ã€‘`;
Â Â Â Â Â Â Â Â logDebug(`setDecisionMode: Successfully set mode ${mode}`);
Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â logDebug(`setDecisionMode: Firebase error: ${error.message}`);
Â Â Â Â Â Â Â Â console.error('setDecisionMode: Firebase error:', error);
Â Â Â Â Â Â Â Â showModal('è¨­ç½®æ±ºå®šæ–¹å¼å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â }
}

function showFinalResult(result) {

Â Â Â Â // 1. éš±è—æŠ½ç±¤æŒ‰éˆ•å’Œæ±ºå®šæ–¹å¼
Â Â Â Â const drawBtn = document.querySelector('#decidePage .btn-draw');
Â Â Â Â if (drawBtn) drawBtn.style.display = 'none';
Â Â Â Â const modeBtn = document.querySelector('#decidePage .btn-primary[onclick="chooseDecisionMode()"]');
Â Â Â Â if (modeBtn) modeBtn.style.display = 'none';

Â Â Â Â logDebug(`showFinalResult: Displaying final result: ${result}`);
Â Â Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â Â Â const confirmRef = db.ref(`rooms/${roomId}/confirm`);
Â Â Â Â const reeditRef = db.ref(`rooms/${roomId}/editConfirm`);
Â Â Â Â const voteRef = db.ref(`rooms/${roomId}/vote`);

Â Â Â Â confirmRef.remove();
Â Â Â Â reeditRef.remove();
Â Â Â Â voteRef.remove();
Â Â Â Â voteRef.off('value');
Â Â Â Â closeAllModals();
Â Â Â Â logDebug("showFinalResult: Cleared confirm, reedit, and vote data");

Â Â Â Â const modal = document.createElement('div');
Â Â Â Â modal.className = 'modal';
Â Â Â Â modal.dataset.modalId = 'finalResult';
Â Â Â Â const modalContent = document.createElement('div');
Â Â Â Â modalContent.className = 'modal-content';
Â Â Â Â modalContent.innerHTML = `
Â Â Â Â Â Â Â Â <h2 style="font-size:2em;">ğŸ‰ æœ€çµ‚çµæœ ğŸ‰</h2>
Â Â Â Â Â Â Â Â <p style="font-size:1.8em; color:#3db8c4; font-weight:bold; margin: 20px 0;">${result}</p>
Â Â Â Â Â Â Â Â <p style="font-size:1em;">çµæœå·²å‡ºçˆï¼Œè«‹å‹™å¿…éµå®ˆå“¦ï¼</p>
Â Â Â Â `;

Â Â Â Â confettiEffect();

Â Â Â Â const btn = document.createElement('button');
btn.className = 'btn-confirm';
btn.textContent = 'é—œé–‰';
btn.onclick = () => {
Â Â Â Â logDebug("showFinalResult: Close button clicked");
Â Â Â Â modal.remove();
Â Â Â Â safeEnableDrawBtn(); // â† ä½¿ç”¨å†·å»æ©Ÿåˆ¶å•Ÿç”¨æŒ‰éˆ•
};

modalContent.appendChild(btn);
Â Â Â Â modal.appendChild(modalContent);
Â Â Â Â document.body.appendChild(modal);
Â showCertificate(result);
}

function confettiEffect() {
Â Â Â Â logDebug("confettiEffect: Starting confetti animation");
Â Â Â Â for (let i = 0; i < 30; i++) {
Â Â Â Â Â Â Â Â const confetti = document.createElement('div');
Â Â Â Â Â Â Â Â confetti.textContent = 'ğŸŠ';
Â Â Â Â Â Â Â Â confetti.style.position = 'fixed';
Â Â Â Â Â Â Â Â confetti.style.top = '-50px';
Â Â Â Â Â Â Â Â confetti.style.left = Math.random() * 100 + 'vw';
Â Â Â Â Â Â Â Â confetti.style.fontSize = '2em';
Â Â Â Â Â Â Â Â confetti.style.animation = `fall ${2 + Math.random() * 3}s linear forwards`;
Â Â Â Â Â Â Â Â document.body.appendChild(confetti);
Â Â Â Â Â Â Â Â confetti.addEventListener('animationend', () => {
Â Â Â Â Â Â Â Â Â Â Â Â confetti.remove();
Â Â Â Â Â Â Â Â });
Â Â Â Â }
}

async function initiateVoting(mode, finalItem) {
Â Â Â Â logDebug(`initiateVoting: Starting voting for item ${finalItem}, mode: ${mode}`);
Â Â Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â Â Â const voteRef = db.ref(`rooms/${roomId}/vote`);
Â Â Â Â try {
Â Â Â Â Â Â Â Â if (!finalItem) {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug("initiateVoting: Invalid finalItem");
Â Â Â Â Â Â Â Â Â Â Â Â showModal('æŠ½ç±¤çµæœç„¡æ•ˆï¼Œè«‹é‡æ–°æŠ½ç±¤ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â // å…ˆæª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æŠ•ç¥¨è³‡æ–™ï¼Œæ²’æœ‰å†å¯«
Â Â Â Â Â Â Â Â const voteSnap = await voteRef.once('value');
Â Â Â Â Â Â Â Â if (voteSnap.exists()) {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug("initiateVoting: Voting already initialized, skip.");
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â await voteRef.set({
Â Â Â Â Â Â Â Â Â Â Â Â active: true,
Â Â Â Â Â Â Â Â Â Â Â Â item: finalItem,
Â Â Â Â Â Â Â Â Â Â Â Â mode: mode,
Â Â Â Â Â Â Â Â Â Â Â Â votes: {},
Â Â Â Â Â Â Â Â Â Â Â Â timestamp: firebase.database.ServerValue.TIMESTAMP
Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â logDebug("initiateVoting: Voting initialized");
Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â logDebug(`initiateVoting: Firebase error: ${error.message}`);
Â Â Â Â Â Â Â Â showModal('æŠ•ç¥¨å•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â }
}


async function requestReedit() {
Â Â Â Â logDebug("requestReedit: Starting reedit request");
Â Â Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â Â Â const userId = localStorage.getItem(`currentUserId_${roomId}`);
Â Â Â Â if (!userId) {
Â Â Â Â Â Â Â Â logDebug("requestReedit: No userId found in localStorage");
Â Â Â Â Â Â Â Â showModal('ç”¨æˆ¶èº«ä»½é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°åŠ å…¥æˆ¿é–“ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => { window.location.reload(); } }
Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â return;
Â Â Â Â }
Â Â Â Â logDebug(`requestReedit: Current userId: ${userId}`);
Â Â Â Â const reeditRef = db.ref(`rooms/${roomId}/editConfirm`);
Â Â Â Â const reeditBtn = document.querySelector('#decidePage .btn-primary[onclick="requestReedit()"]');
Â Â Â Â reeditBtn.disabled = true;
Â Â Â Â reeditBtn.innerHTML = '<span class="spin-animation">â³</span> æäº¤ä¸­...';
Â Â Â Â logDebug("requestReedit: Button disabled, initiating request");

Â Â Â Â try {
Â Â Â Â Â Â Â Â const participantSnap = await db.ref(`rooms/${roomId}/participants/${userId}`).once('value');
Â Â Â Â Â Â Â Â if (!participantSnap.exists()) {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug("requestReedit: UserId not found in participants");
Â Â Â Â Â Â Â Â Â Â Â Â showModal('ç”¨æˆ¶èº«ä»½ç„¡æ•ˆï¼Œè«‹é‡æ–°åŠ å…¥æˆ¿é–“ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => { window.location.reload(); } }
Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â reeditBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â reeditBtn.innerHTML = 'â† é‡æ–°ç·¨è¼¯';
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â // æ”¹å‹•ï¼šç§»é™¤è‡ªå‹•åŒæ„ï¼Œåƒ…è¨­ç½®é‡æ–°ç·¨è¼¯è«‹æ±‚
Â Â Â Â Â Â Â Â await reeditRef.transaction(currentData => {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug("requestReedit: Clearing reedit data via transaction");
Â Â Â Â Â Â Â Â Â Â Â Â return null;
Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â const userName = participantSnap.val().name || 'æœªçŸ¥';
Â Â Â Â Â Â Â Â await reeditRef.set({
Â Â Â Â Â Â Â Â Â Â Â Â active: true,
Â Â Â Â Â Â Â Â Â Â Â Â initiator: userId,
Â Â Â Â Â Â Â Â Â Â Â Â initiatorName: userName,
Â Â Â Â Â Â Â Â Â Â Â Â status: 'pending',
Â Â Â Â Â Â Â Â Â Â Â Â responses: {}, // æ”¹å‹•ï¼šä¸é è¨­ç™¼èµ·äººåŒæ„
Â Â Â Â Â Â Â Â Â Â Â Â timestamp: firebase.database.ServerValue.TIMESTAMP
Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â logDebug(`requestReedit: Set reedit data for initiator ${userName} (${userId})`);
Â Â Â Â Â Â Â Â showWaitingModal(reeditRef, userId, 'å·²ç™¼èµ·é‡æ–°ç·¨è¼¯ï¼Œç­‰å¾…æ‰€æœ‰äººåŒæ„...', 'reedit');
Â Â Â Â Â Â Â Â reeditBtn.disabled = false;
Â Â Â Â Â Â Â Â reeditBtn.innerHTML = 'â† é‡æ–°ç·¨è¼¯';
Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â logDebug(`requestReedit: Firebase error: ${error.message}`);
Â Â Â Â Â Â Â Â console.error('requestReedit: Firebase è¨­å®šéŒ¯èª¤:', error);
Â Â Â Â Â Â Â Â showModal('é‡æ–°ç·¨è¼¯è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â reeditBtn.disabled = false;
Â Â Â Â Â Â Â Â reeditBtn.innerHTML = 'â† é‡æ–°ç·¨è¼¯';
Â Â Â Â }
}

function listenReedit(roomId) {
Â Â Â Â logDebug("listenReedit: Starting reedit listener");
Â Â Â Â const reeditRef = db.ref(`rooms/${roomId}/editConfirm`);
Â Â Â Â const modalId = 'reedit';
Â Â Â Â let lastProcessedData = null;

Â Â Â Â reeditRef.on('value', debounce(async snap => {
Â Â Â Â Â Â Â Â const data = snap.val();
Â Â Â Â Â Â Â Â const dataString = JSON.stringify(data);
Â Â Â Â Â Â Â Â if (dataString === lastProcessedData) {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenReedit: Data unchanged, skipping");
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â lastProcessedData = dataString;
Â Â Â Â Â Â Â Â logDebug(`listenReedit: Received data: ${dataString}, User: ${userId}`);

Â Â Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â Â Â Â Â const roomSnap = await db.ref(`rooms/${roomId}`).once('value');
Â Â Â Â Â Â Â Â Â Â Â Â const roomData = roomSnap.val() || {};
Â Â Â Â Â Â Â Â Â Â Â Â const isDeciding = roomData.isDeciding;
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`listenReedit: isDeciding: ${isDeciding}`);

Â Â Â Â Â Â Â Â Â Â Â Â if (!isDeciding) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenReedit: Not in deciding phase, clearing reedit data");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await reeditRef.remove();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeModalById(modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._reeditCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (!data) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenReedit: editConfirm is null, closing modal");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeModalById(modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._reeditCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (data.status === 'cancelled') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenReedit: Reedit process cancelled!");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._reeditCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // æ‰¾å‡ºåå°è€…åç¨±ï¼ˆæˆ–æœªçŸ¥ç”¨æˆ¶ï¼‰
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â let cancelledByName = 'æœªçŸ¥ç”¨æˆ¶';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (data.responses) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const refusers = Object.entries(data.responses).filter(([uid, v]) => v === false);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (refusers.length > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const [refuseId] = refusers[0];
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const snap = await db.ref(`rooms/${roomId}/participants/${refuseId}`).once('value');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â cancelledByName = snap.val() && snap.val().name ? snap.val().name : 'æœªçŸ¥ç”¨æˆ¶';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal(
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â `â… é‡æ–°ç·¨è¼¯æµç¨‹å·²è¢« ${cancelledByName} å–æ¶ˆï¼`,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â [{ text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 'error'
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â );
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // ä¸åˆ‡é ï¼åªé¡¯ç¤ºè¨Šæ¯
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (!data.active || data.status !== 'pending') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenReedit: No active reedit or not pending, cleaning up");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await reeditRef.remove();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeModalById(modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._reeditCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (!data.initiator || !data.initiatorName) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenReedit: Invalid initiator data, ignoring");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await reeditRef.remove();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeModalById(modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._reeditCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â const participantSnap = await db.ref(`rooms/${roomId}/participants`).once('value');
Â Â Â Â Â Â Â Â Â Â Â Â const participants = participantSnap.val() || {};
Â Â Â Â Â Â Â Â Â Â Â Â const total = Object.keys(participants).length;
Â Â Â Â Â Â Â Â Â Â Â Â const responses = data.responses || {};
Â Â Â Â Â Â Â Â Â Â Â Â const agreeCount = Object.values(responses).filter(v => v === true).length;
Â Â Â Â Â Â Â Â Â Â Â Â const disagreeCount = Object.values(responses).filter(v => v === false).length;
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`listenReedit: Total participants: ${total}, Agree: ${agreeCount}, Disagree: ${disagreeCount}, User: ${userId}`);

Â Â Â Â Â Â Â Â Â Â Â Â // æ›´æ–°ç¥¨æ•¸
Â Â Â Â Â Â Â Â Â Â Â Â await reeditRef.update({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â agreeCount: agreeCount,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â disagreeCount: disagreeCount
Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`listenReedit: Updated counts - Agree: ${agreeCount}, Disagree: ${disagreeCount}`);

Â Â Â Â Â Â Â Â Â Â Â Â const progressText = `ï¼ˆç›®å‰ ${agreeCount} äººåŒæ„ï¼Œ${disagreeCount} äººä¸åŒæ„ï¼‰`;

Â Â Â Â Â Â Â Â Â Â Â Â // åªè¦æœ‰äººä¸åŒæ„ï¼Œå°±å½ˆçª—ï¼Œä¸å‹•ä»»ä½•ç‹€æ…‹ï¼Œä¸åˆ‡é 
Â Â Â Â Â Â Â Â Â Â Â Â if (disagreeCount > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenReedit: Someone disagreed, cancelling");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await reeditRef.update({ status: 'cancelled', active: false });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._reeditCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal(
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â `â… æœ‰äººä¸åŒæ„é‡æ–°ç·¨è¼¯ï¼ˆ${agreeCount} åŒæ„ï¼Œ${disagreeCount} ä¸åŒæ„ï¼‰ï¼Œæµç¨‹å·²å–æ¶ˆã€‚`,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â [{ text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 'error'
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â );
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // ä¸åˆ‡é ã€ä¸å‹• isDeciding
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â // åªæœ‰å…¨åŒæ„ï¼Œæ‰åˆ‡é é‚„åŸæ‰€æœ‰ç‹€æ…‹
Â Â Â Â Â Â Â Â Â Â Â Â if (agreeCount === total && total > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenReedit: All agreed, returning to multiPage");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await reeditRef.update({ status: 'completed', active: false });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await db.ref(`rooms/${roomId}`).update({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â isDeciding: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â finalResult: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawResult: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â isDrawing: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â vote: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â confirm: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â editConfirm: null
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._reeditCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal('âœ… æ‰€æœ‰äººåŒæ„ï¼Œè¿”å›ç·¨è¼¯æ¸…å–®ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: 'å¥½çš„',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-confirm',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onClick: () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const decidePage = document.getElementById('decidePage');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const multiPage = document.getElementById('multiPage');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (!multiPage.classList.contains('active')) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â decidePage.classList.remove('active');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â multiPage.classList.add('active');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â listenVote(roomId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'success');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â // å·²åŒæ„çš„ç”¨æˆ¶ï¼Œé¡¯ç¤ºç­‰å¾…
Â Â Â Â Â Â Â Â Â Â Â Â if (responses[userId] === true) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showWaitingModal(reeditRef, userId, `å·²åŒæ„ï¼Œç­‰å¾…å…¶ä»–äººåŒæ„ä¸­... <br>${progressText}`, modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â clearTimeout(window._reeditTimeout);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._reeditCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â showModal(`å·²ç™¼èµ·é‡æ–°ç·¨è¼¯ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ<br>${progressText}`, [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: 'åŒæ„',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-confirm',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onClick: async () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â clearTimeout(window._reeditTimeout);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._reeditCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await reeditRef.child('responses').child(userId).set(true);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showWaitingModal(reeditRef, userId, `å·²åŒæ„ï¼Œç­‰å¾…å…¶ä»–äººåŒæ„ä¸­... <br>${progressText}`, modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: 'ä¸åŒæ„',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-primary',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onClick: async () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â clearTimeout(window._reeditTimeout);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._reeditCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await reeditRef.child('responses').child(userId).set(false);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â ], modalId);

Â Â Â Â Â Â Â Â Â Â Â Â // ====== å€’æ•¸å‹•ç•« + è‡ªå‹•åŒæ„ ======
Â Â Â Â Â Â Â Â Â Â Â Â if (!window._reeditCountdownStartTime) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._reeditCountdownStartTime = Date.now();
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â showVoteCountdown(25, window._reeditCountdownStartTime);
Â Â Â Â Â Â Â Â Â Â Â Â clearTimeout(window._reeditTimeout);
Â Â Â Â Â Â Â Â Â Â Â Â let remain = 25 - Math.floor((Date.now() - window._reeditCountdownStartTime) / 1000);
Â Â Â Â Â Â Â Â Â Â Â Â if (remain < 0) remain = 0;
Â Â Â Â Â Â Â Â Â Â Â Â window._reeditTimeout = setTimeout(async () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeModalById(modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._reeditCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await reeditRef.child('responses').child(userId).set(true);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showWaitingModal(reeditRef, userId, `ï¼ˆå·²è‡ªå‹•åŒæ„ï¼‰ç­‰å¾…å…¶ä»–äººåŒæ„ä¸­... <br>${progressText}`, modalId);
Â Â Â Â Â Â Â Â Â Â Â Â }, remain * 1000);

Â Â Â Â Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`listenReedit: Error: ${error.message}`);
Â Â Â Â Â Â Â Â Â Â Â Â window._reeditCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â showModal('é‡æ–°ç·¨è¼¯è™•ç†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â }
Â Â Â Â }, 500));
}

async function getDrawData(roomRef, retry = 0) {
Â Â const [spinListSnap, resultSnap] = await Promise.all([
Â Â Â Â roomRef.child('drawAnimation').once('value'),
Â Â Â Â roomRef.child('drawResult').once('value')
Â Â ]);
Â Â const spinList = spinListSnap.val() || [];
Â Â const finalItem = resultSnap.val();
Â Â // å¦‚æœªæŠ“åˆ°ï¼Œæœ€å¤š retry 5 æ¬¡ï¼ˆ0.12s*5=0.6ç§’ï¼‰
Â Â if ((!spinList.length || !finalItem) && retry < 5) {
Â Â Â Â await new Promise(r => setTimeout(r, 120));
Â Â Â Â return await getDrawData(roomRef, retry + 1);
Â Â }
Â Â return { spinList, finalItem };
}

// é€™å€‹ util è«‹è²¼åœ¨ script å…§ä¸€æ¬¡å³å¯
async function getDrawData(roomRef, retry = 0) {
Â Â const [spinListSnap, resultSnap] = await Promise.all([
Â Â Â Â roomRef.child('drawAnimation').once('value'),
Â Â Â Â roomRef.child('drawResult').once('value')
Â Â ]);
Â Â const spinList = spinListSnap.val() || [];
Â Â const finalItem = resultSnap.val();
Â Â if ((!spinList.length || !finalItem) && retry < 5) {
Â Â Â Â await new Promise(r => setTimeout(r, 120));
Â Â Â Â return await getDrawData(roomRef, retry + 1);
Â Â }
Â Â return { spinList, finalItem };
}

async function playDrawAnimation(roomId) {
Â Â logDebug("playDrawAnimation: Starting draw animation");
Â Â const roomRef = db.ref(`rooms/${roomId}`);
Â Â try {
Â Â Â Â Â Â const finalResultSnap = await roomRef.child('finalResult').once('value');
Â Â Â Â Â Â if (finalResultSnap.val()) {
Â Â Â Â Â Â Â Â Â Â showModal(`æœ¬æ¬¡çµæœ[${finalResultSnap.val()}]ï¼Œè«‹å‹™å¿…éµå®ˆå“¦ï¼`, [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â ], 'info');
Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â }

Â Â Â Â Â Â // â˜… ç”¨ getDrawDataï¼Œé¿å…æŠ“åˆ°ç©ºçš„å‹•ç•«è³‡æ–™
Â Â Â Â Â Â const modeSnap = await roomRef.child('decisionMode').once('value');
Â Â Â Â Â Â const mode = modeSnap.val() || 'ä¸€æŠ½å…¥é­‚';
Â Â Â Â Â Â const { spinList, finalItem } = await getDrawData(roomRef);

Â Â Â Â Â Â if (!spinList.length || !finalItem) {
Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â showModal('æ¸…å–®ç„¡é …ç›®ï¼Œè«‹é‡æ–°ç¢ºèªï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â roomRef.update({ isDrawing: null, drawAnimation: null });
Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â }

Â Â Â Â Â Â // æ–°å‹•ç•«æ¨¡çµ„
Â Â Â Â Â Â closeModalById('drawAnimation');
Â Â Â Â Â Â const modal = document.createElement('div');
Â Â Â Â Â Â modal.className = 'modal';
Â Â Â Â Â Â modal.dataset.modalId = 'drawAnimation';

Â Â Â Â Â Â const modalContent = document.createElement('div');
Â Â Â Â Â Â modalContent.className = 'modal-content';

Â Â Â Â Â Â // åŠ å…¥å‹•ç•«å¤–æ¡†
Â Â Â Â Â Â const frame = document.createElement('div');
Â Â Â Â Â Â frame.className = 'lottery-animate-frame';

Â Â Â Â Â Â const resultArea = document.createElement('div');
Â Â Â Â Â Â resultArea.className = 'lottery-animate-text';
Â Â Â Â Â Â resultArea.textContent = 'ğŸ° æŠ½ç±¤ä¸­...';

Â Â Â Â Â Â frame.appendChild(resultArea);
Â Â Â Â Â Â modalContent.appendChild(frame);
Â Â Â Â Â Â modal.appendChild(modalContent);
Â Â Â Â Â Â document.body.appendChild(modal);

Â Â Â Â Â Â // æŸ”å’Œæ¼¸å±¤é…è‰²è¼ªæ›¿
Â Â Â Â Â Â const bgColors = [
Â Â Â Â Â Â Â Â 'linear-gradient(135deg,#fff3e3 0%,#ffe8ee 100%)',
Â Â Â Â Â Â Â Â 'linear-gradient(135deg,#f0f9ff 0%,#e6ffe9 100%)',
Â Â Â Â Â Â Â Â 'linear-gradient(135deg,#ffede0 0%,#f2f3ff 100%)',
Â Â Â Â Â Â Â Â 'linear-gradient(135deg,#fff7eb 0%,#f9e7f7 100%)',
Â Â Â Â Â Â Â Â 'linear-gradient(135deg,#fffbe2 0%,#fff3e3 100%)'
Â Â Â Â Â Â ];
Â Â Â Â Â Â const textColors = [
Â Â Â Â Â Â Â Â '#FF4D4F', '#3db8c4', '#FFA63C', '#FF7577', '#3CC288'
Â Â Â Â Â Â ];

Â Â Â Â Â Â let index = 0;
Â Â Â Â Â Â let total = spinList.length;
Â Â Â Â Â Â let time = 75; // æœ€å¿«é€Ÿåº¦
Â Â Â Â Â Â function animate() {
Â Â Â Â Â Â Â Â if (index >= total) {
Â Â Â Â Â Â Â Â Â Â // æœ€å¾Œä¸€æ ¼å®šæ ¼å¤§å­—+é–ƒå…‰
Â Â Â Â Â Â Â Â Â Â resultArea.className = 'lottery-animate-text lottery-final-blue';
Â Â Â Â Â Â Â Â Â Â frame.classList.add('lottery-final-bg-blue');
Â Â Â Â Â Â Â Â Â Â resultArea.textContent = finalItem;

Â Â Â Â Â Â Â Â Â Â // è®“ä½¿ç”¨è€…è®€ 2.5 ç§’å†æ…¢æ…¢æ¶ˆå¤±
Â Â Â Â Â Â Â Â Â Â setTimeout(async () => {
Â Â Â Â Â Â Â Â Â Â Â Â resultArea.style.transition = 'opacity 0.8s';
Â Â Â Â Â Â Â Â Â Â Â Â resultArea.style.opacity = 0;
Â Â Â Â Â Â Â Â Â Â Â Â setTimeout(async () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â modal.remove();

Â Â Â Â Â Â Â Â Â Â Â Â Â Â // === â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒåŒæ­¥å¯«æ³• â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜… ===
Â Â Â Â Â Â Â Â Â Â Â Â Â Â // 1. ç™»è¨˜ã€Œæˆ‘ã€å·²ç¶“çœ‹éå‹•ç•«
Â Â Â Â Â Â Â Â Â Â Â Â Â Â await roomRef.child('drawAnimationSeen').child(userId).set(true);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â // 2. æª¢æŸ¥æ‰€æœ‰åƒèˆ‡è€…æ˜¯å¦éƒ½çœ‹é
Â Â Â Â Â Â Â Â Â Â Â Â Â Â const participantsSnap = await roomRef.child('participants').once('value');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â const participants = Object.keys(participantsSnap.val() || {});
Â Â Â Â Â Â Â Â Â Â Â Â Â Â const seenSnap = await roomRef.child('drawAnimationSeen').once('value');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â const seenUsers = Object.keys(seenSnap.val() || {});

Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (participants.every(uid => seenUsers.includes(uid))) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // 3. æœ€å¾Œä¸€äººæ¸…è³‡æ–™
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await roomRef.update({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â isDrawing: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawAnimation: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawAnimationSeen: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawResult: null
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â // â˜…â˜…â˜… å¾ŒçºŒæµç¨‹
Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (mode === 'ä¸€æŠ½å…¥é­‚') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â roomRef.update({ finalResult: finalItem });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â initiateVoting(mode, finalItem).then(() => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â listenVote(roomId); // Reattach vote listener
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â }, 800); // æ·¡å‡ºå‹•ç•«
Â Â Â Â Â Â Â Â Â Â }, 2500); // çµ¦äººæ™‚é–“çœ‹çµæœ

Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â // è·‘é¦¬ç‡ˆæ•ˆæœ
Â Â Â Â Â Â Â Â resultArea.className = 'lottery-animate-text';
Â Â Â Â Â Â Â Â resultArea.textContent = spinList[index];

Â Â Â Â Â Â Â Â // è®“èƒŒæ™¯ï¼†å­—é«”è‰²å½©è¼ªæµæ›
Â Â Â Â Â Â Â Â const bg = bgColors[index % bgColors.length];
Â Â Â Â Â Â Â Â const tc = textColors[index % textColors.length];
Â Â Â Â Â Â Â Â frame.style.background = bg;
Â Â Â Â Â Â Â Â resultArea.style.color = tc;

Â Â Â Â Â Â Â Â // æ¨¡æ“¬æŠ½ç±¤ç·Šå¼µæ„Ÿï¼šå¾Œæ®µè®Šæ…¢
Â Â Â Â Â Â Â Â if (index > total * 0.72) time += 32;
Â Â Â Â Â Â Â Â if (index > total * 0.87) time += 48;

Â Â Â Â Â Â Â Â index++;
Â Â Â Â Â Â Â Â setTimeout(() => requestAnimationFrame(animate), time);
Â Â Â Â Â Â }

Â Â Â Â Â Â requestAnimationFrame(animate);
Â Â } catch (error) {
Â Â Â Â Â Â logDebug(`playDrawAnimation: Firebase error: ${error.message}`);
Â Â Â Â Â Â showModal('æŠ½ç±¤å‹•ç•«å¤±æ•—ï¼Œè«‹é‡æ–°æŠ½ç±¤ï¼', [
Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â roomRef.update({ isDrawing: null, drawAnimation: null });
Â Â }
}


async function importItems() {
Â Â Â Â logDebug("importItems: Starting item import");
Â Â Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â Â Â let text = prompt('è«‹è²¼ä¸Šè¦åŒ¯å…¥çš„é …ç›®ï¼ˆJSON æˆ–æ¯è¡Œä¸€é …ï¼‰ï¼š');
Â Â Â Â if (!text) {
Â Â Â Â Â Â Â Â logDebug("importItems: No input provided");
Â Â Â Â Â Â Â Â return;
Â Â Â Â }
Â Â Â Â text = text.trim(); // é—œéµï¼šå»é ­å°¾ç©ºç™½ã€ç©ºè¡Œ

Â Â Â Â let items = [];
Â Â Â Â try {
Â Â Â Â Â Â Â Â const parsed = JSON.parse(text);
Â Â Â Â Â Â Â Â if (parsed && parsed.items) {
Â Â Â Â Â Â Â Â Â Â Â Â // ä¸ç®¡æ˜¯ä¸æ˜¯é™£åˆ—ï¼Œåªè¦æœ‰ items éƒ½æŠ“
Â Â Â Â Â Â Â Â Â Â Â Â if (Array.isArray(parsed.items)) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â items = parsed.items;
Â Â Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â items = [parsed.items];
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â } else if (Array.isArray(parsed)) {
Â Â Â Â Â Â Â Â Â Â Â Â items = parsed;
Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â throw new Error();
Â Â Â Â Â Â Â Â }
Â Â Â Â } catch {
Â Â Â Â Â Â Â Â // JSON è§£æå¤±æ•—ï¼Œç•¶æ›è¡Œ
Â Â Â Â Â Â Â Â items = text.split('\n').map(s => s.trim()).filter(Boolean);
Â Â Â Â }

Â Â Â Â if (!items.length) {
Â Â Â Â Â Â Â Â logDebug("importItems: No valid items to import");
Â Â Â Â Â Â Â Â showModal('æ²’æœ‰å¯åŒ¯å…¥çš„é …ç›®ï¼Œè«‹æª¢æŸ¥æ ¼å¼ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â return;
Â Â Â Â }
Â Â Â Â logDebug(`importItems: Parsed ${items.length} items`);

Â Â Â Â const importBtn = document.querySelector('#multiPage .btn-primary[onclick="importItems()"]');
Â Â Â Â if (importBtn) {
Â Â Â Â Â Â Â Â importBtn.disabled = true;
Â Â Â Â Â Â Â Â importBtn.innerHTML = '<span class="spin-animation">â³</span> åŒ¯å…¥ä¸­...';
Â Â Â Â }
Â Â Â Â logDebug("importItems: Button disabled, importing items");

Â Â Â Â const listRef = db.ref('rooms/' + roomId + '/list');
Â Â Â Â const maxRetries = 3;
Â Â Â Â let attempt = 0;

Â Â Â Â while (attempt < maxRetries) {
Â Â Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â Â Â Â Â const snapshot = await listRef.once('value');
Â Â Â Â Â Â Â Â Â Â Â Â let list = snapshot.val() || [];
Â Â Â Â Â Â Â Â Â Â Â Â list = list.concat(items);
Â Â Â Â Â Â Â Â Â Â Â Â await listRef.set(list);
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`importItems: Imported ${items.length} items`);
Â Â Â Â Â Â Â Â Â Â Â Â if (importBtn) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â importBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â importBtn.innerHTML = 'åŒ¯å…¥';
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â Â attempt++;
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`importItems: Error on attempt ${attempt}: ${error.message}`);
Â Â Â Â Â Â Â Â Â Â Â Â if (attempt === maxRetries) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.error('importItems: Firebase error after retries:', error);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal('åŒ¯å…¥é …ç›®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (importBtn) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â importBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â importBtn.innerHTML = 'åŒ¯å…¥';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â await new Promise(resolve => setTimeout(resolve, 1000));
Â Â Â Â Â Â Â Â }
Â Â Â Â }
}


function listenVote(roomId) {
Â Â Â Â logDebug("listenVote: Starting vote listener");
Â Â Â Â const voteRef = db.ref(`rooms/${roomId}/vote`);
Â Â Â Â const modalId = 'vote';
Â Â Â Â let lastProcessedData = null;
Â Â Â Â let voteTimeout = null;
Â Â Â Â let modalOpened = false;

Â Â Â Â function clearVoteTimer() {
Â Â Â Â Â Â Â Â if (voteTimeout) { clearTimeout(voteTimeout); voteTimeout = null; }
Â Â Â Â }

Â Â Â Â voteRef.on('value', debounce(async snap => {
Â Â Â Â Â Â Â Â const data = snap.val();
Â Â Â Â Â Â Â Â const dataString = JSON.stringify(data);
Â Â Â Â Â Â Â Â if (dataString === lastProcessedData) {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenVote: Data unchanged, skipping");
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â lastProcessedData = dataString;
Â Â Â Â Â Â Â Â logDebug(`listenVote: Received data: ${dataString}`);

Â Â Â Â Â Â Â Â clearVoteTimer();

Â Â Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â Â Â Â Â const finalResultSnap = await db.ref(`rooms/${roomId}/finalResult`).once('value');
Â Â Â Â Â Â Â Â Â Â Â Â if (finalResultSnap.val()) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenVote: Final result exists, terminating vote listener");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await voteRef.remove();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â voteRef.off('value');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeModalById(modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â modalOpened = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._voteCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (!data || !data.active || !data.item || data.status === 'cancelled') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug("listenVote: No active vote or invalid item, removing listener and clearing vote");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeModalById(modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await voteRef.remove();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â voteRef.off('value');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â modalOpened = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._voteCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â const item = data.item;
Â Â Â Â Â Â Â Â Â Â Â Â const mode = data.mode;
Â Â Â Â Â Â Â Â Â Â Â Â const votes = data.votes || {};

Â Â Â Â Â Â Â Â Â Â Â Â const participantSnap = await db.ref(`rooms/${roomId}/participants`).once('value');
Â Â Â Â Â Â Â Â Â Â Â Â const participants = participantSnap.val() || {};
Â Â Â Â Â Â Â Â Â Â Â Â const total = Object.keys(participants).length;
Â Â Â Â Â Â Â Â Â Â Â Â const agreeCount = Object.values(votes).filter(v => v === true).length;
Â Â Â Â Â Â Â Â Â Â Â Â const disagreeCount = Object.values(votes).filter(v => v === false).length;
Â Â Â Â Â Â Â Â Â Â Â Â const totalVotes = Object.keys(votes).length;
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`listenVote: Total participants: ${total}, Agree: ${agreeCount}, Disagree: ${disagreeCount}, Total votes: ${totalVotes}`);

Â Â Â Â Â Â Â Â Â Â Â Â await voteRef.update({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â agreeCount: agreeCount,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â disagreeCount: disagreeCount
Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`listenVote: Updated counts - Agree: ${agreeCount}, Disagree: ${disagreeCount}`);

Â Â Â Â Â Â Â Â Â Â Â Â const progressText = `ï¼ˆç›®å‰ ${agreeCount} äººåŒæ„ï¼Œ${disagreeCount} äººä¸åŒæ„ï¼‰`;

Â Â Â Â Â Â Â Â Â Â Â Â // ======= æŠ•ç¥¨ modal & å€’æ•¸æ¢ =======
Â Â Â Â Â Â Â Â Â Â Â Â if (!(userId in votes)) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`listenVote: User ${userId} has not voted, showing vote modal`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (!modalOpened) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal(
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â `æ˜¯å¦åŒæ„å°‡ã€Œ${item}ã€ä½œç‚ºæœ€çµ‚çµæœï¼Ÿ<br><span id="vote-progress-text">${progressText}</span>`,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: 'åŒæ„',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-confirm',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onClick: async () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â clearVoteTimer();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeModalById(modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â modalOpened = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._voteCountdownStartTime = null; // é€™è£¡æ¸…é™¤
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await voteRef.child('votes/' + userId).set(true);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showWaitingModal(voteRef, userId, `å·²åŒæ„ï¼Œç­‰å¾…å…¶ä»–äººæŠ•ç¥¨ä¸­... <br>${progressText}`, modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â lastProcessedData = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: 'ä¸åŒæ„',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-primary',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onClick: async () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â clearVoteTimer();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â modalOpened = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._voteCountdownStartTime = null; // é€™è£¡æ¸…é™¤
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await voteRef.child('votes/' + userId).set(false);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â lastProcessedData = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â modalId
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â );
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â modalOpened = true;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // ğŸŸ¢ åªåœ¨ç¬¬ä¸€æ¬¡å½ˆçª—è¨­å®š startTime
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (!window._voteCountdownStartTime) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._voteCountdownStartTime = Date.now();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showVoteCountdown(25, window._voteCountdownStartTime);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // 25ç§’å¾Œè‡ªå‹•åŒæ„
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â voteTimeout = setTimeout(() => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â clearVoteTimer();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeModalById(modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â modalOpened = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._voteCountdownStartTime = null; // é€™è£¡æ¸…é™¤
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â voteRef.child('votes/' + userId).set(true);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showWaitingModal(voteRef, userId, `ï¼ˆå·²è‡ªå‹•åŒæ„ï¼‰ç­‰å¾…å…¶ä»–äººæŠ•ç¥¨ä¸­... <br>${progressText}`, modalId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â lastProcessedData = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }, 25000);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // åªæ›´æ–°æŠ•ç¥¨é€²åº¦æ–‡å­—
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const progressEl = document.getElementById('vote-progress-text');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (progressEl) progressEl.textContent = progressText;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // ğŸŸ¢ è³‡æ–™åˆ·æ–°æ™‚ä¹Ÿé‡ç¹ªå€’æ•¸æ¢ï¼ˆä¸é‡è¨­ startTimeï¼‰
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (window._voteCountdownStartTime) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showVoteCountdown(25, window._voteCountdownStartTime);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â clearVoteTimer();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â modalOpened = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._voteCountdownStartTime = null; // æŠ•éå°±æ¸…é™¤
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`listenVote: User ${userId} has voted, showing waiting modal`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showWaitingModal(voteRef, userId, `å·²æŠ•ç¥¨ï¼Œç­‰å¾…å…¶ä»–äººæŠ•ç¥¨ä¸­... <br>${progressText}`, modalId);
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â // åˆ¤æ–·ç¥¨æ•¸
Â Â Â Â Â Â Â Â Â Â Â Â if (mode === 'å…±è­˜æ±º') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (totalVotes === total) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._voteCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (agreeCount === total) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await db.ref(`rooms/${roomId}`).update({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â finalResult: item,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â isDrawing: null
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â voteRef.off('value');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â modalOpened = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â modalOpened = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal(
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â `âŒ æœªé”æˆæ¢ä»¶<br>ï¼ˆ${agreeCount} åŒæ„ï¼Œ${disagreeCount} ä¸åŒæ„ï¼‰ï¼Œè«‹å†æŠ½ä¸€æ¬¡ï¼`,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â [{
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: 'å¥½çš„',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-confirm',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onClick: async () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await db.ref(`rooms/${roomId}`).update({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â vote: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â isDrawing: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawAnimation: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawResult: null
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â safeEnableDrawBtn();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 'error'
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â );
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â } else if (mode === 'å¤šæ•¸æ±º') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (totalVotes === total) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window._voteCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (agreeCount > total / 2) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await db.ref(`rooms/${roomId}`).update({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â finalResult: item,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â isDrawing: null
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â voteRef.off('value');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â modalOpened = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â closeAllModals();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â modalOpened = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal(
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â `âŒ æœªé”æˆæ¢ä»¶ï¼ˆ${agreeCount} åŒæ„ï¼Œ${disagreeCount} ä¸åŒæ„ï¼‰ï¼Œè«‹å†æŠ½ä¸€æ¬¡ï¼`,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â [{
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: 'å¥½çš„',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-confirm',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onClick: async () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await db.ref(`rooms/${roomId}`).update({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â vote: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â isDrawing: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawAnimation: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawResult: null
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const drawBtn = document.querySelector('#decidePage .btn-draw');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (drawBtn) drawBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 'error'
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â );
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`listenVote: Error: ${error.message}`);
Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â Â Â Â Â window._voteCountdownStartTime = null;
Â Â Â Â Â Â Â Â Â Â Â Â showModal('æŠ•ç¥¨è™•ç†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â }
Â Â Â Â }, 500));
}


function leaveRoom() {
Â Â Â Â logDebug && logDebug("leaveRoom: Initiating room exit");
Â Â Â Â // åˆ¤æ–·ç›®å‰æ˜¯ä¸æ˜¯ setupPage
Â Â Â Â if (document.getElementById('setupPage').classList.contains('active')) {
Â Â Â Â Â Â Â Â window.location.href = 'index.html';
Â Â Â Â Â Â Â Â return;
Â Â Â Â }
Â Â Â Â showModal('ç¢ºå®šè¦é›¢é–‹æ­¤æˆ¿é–“å—ï¼Ÿ', [
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â text: 'ç¢ºå®š',
Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-confirm',
Â Â Â Â Â Â Â Â Â Â Â Â onClick: () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug && logDebug("leaveRoom: Confirm leave clicked");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const userId = localStorage.getItem(`currentUserId_${roomId}`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const roomRef = db.ref(`rooms/${roomId}`);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â roomRef.child('participants').transaction(participants => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (!participants) return;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â delete participants[userId];
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const participantCount = Object.keys(participants).length;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â roomRef.child('participants/' + userId).remove();

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (participantCount === 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â roomRef.update({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawResult: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â finalResult: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â isDrawing: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â vote: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â confirm: null,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â editConfirm: null
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â localStorage.removeItem('currentRoomId');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â localStorage.removeItem(`currentUserId_${roomId}`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â window.location.href = 'index.html';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â text: 'å–æ¶ˆ',
Â Â Â Â Â Â Â Â Â Â Â Â class: 'btn-primary',
Â Â Â Â Â Â Â Â Â Â Â Â onClick: () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logDebug && logDebug("leaveRoom: Cancel leave clicked");
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }
Â Â Â Â ], 'leave');
}

function generateVerificationCode() {
Â Â Â Â const digits = Math.floor(Math.random() * 90 + 10).toString();
Â Â Â Â const letters = String.fromCharCode(
Â Â Â Â Â Â Â Â Math.floor(Math.random() * 26) + 97,
Â Â Â Â Â Â Â Â Math.floor(Math.random() * 26) + 97
Â Â Â Â );
Â Â Â Â const code = digits + letters;
Â Â Â Â logDebug(`generateVerificationCode: Generated code ${code}`);
Â Â Â Â return code;
}

window.addEventListener('DOMContentLoaded', function() {
Â Â Â Â // å–å¾—ç¶²å€åƒæ•¸
Â Â Â Â const params = new URLSearchParams(window.location.search);
Â Â Â Â const room = params.get('room');
Â Â Â Â const code = params.get('code');
Â Â Â Â // å¦‚æœæœ‰å°±è‡ªå‹•å¡«å…¥ input
Â Â Â Â if (room) document.getElementById('roomNameInput').value = decodeURIComponent(room);
Â Â Â Â if (code) document.getElementById('verificationCodeInput').value = decodeURIComponent(code);
});

// é é¢è¼‰å…¥å¾ŒåŸ·è¡Œ
window.addEventListener('DOMContentLoaded', function() {
Â Â document.querySelectorAll('.item-container').forEach(function(box) {
Â Â Â Â box.addEventListener('touchstart', function(e) {
Â Â Â Â Â Â // è¨˜ä½è§¸æ§é–‹å§‹æ™‚çš„scrollTop
Â Â Â Â Â Â box._startY = e.touches[0].clientY;
Â Â Â Â Â Â box._startScroll = box.scrollTop;
Â Â Â Â }, {passive: false});

Â Â Â Â box.addEventListener('touchmove', function(e) {
Â Â Â Â Â Â const scrollTop = box.scrollTop;
Â Â Â Â Â Â const scrollHeight = box.scrollHeight;
Â Â Â Â Â Â const offsetHeight = box.offsetHeight;
Â Â Â Â Â Â const atTop = scrollTop === 0;
Â Â Â Â Â Â const atBottom = scrollTop + offsetHeight >= scrollHeight - 1;
Â Â Â Â Â Â const moveY = e.touches[0].clientY - box._startY;
Â Â Â Â Â Â // å‘ä¸‹æ»‘ä¸”åœ¨é ‚éƒ¨ã€æˆ–å‘ä¸Šæ»‘ä¸”åœ¨åº•éƒ¨ => é˜»æ­¢
Â Â Â Â Â Â if ((atTop && moveY > 0) || (atBottom && moveY < 0)) {
Â Â Â Â Â Â Â Â e.preventDefault();
Â Â Â Â Â Â }
Â Â Â Â }, {passive: false});
Â Â });
});
function chooseImportType() {
Â Â showModal('è«‹é¸æ“‡åŒ¯å…¥æ–¹å¼', [
Â Â Â Â {
Â Â Â Â Â Â text: 'ğŸ“è²¼ä¸Š',
Â Â Â Â Â Â class: 'btn-primary',
Â Â Â Â Â Â onClick: () => importItems()
Â Â Â Â },
Â Â Â Â {
Â Â Â Â Â Â text: 'ğŸ“‚æœ¬åœ°',
Â Â Â Â Â Â class: 'btn-primary',
Â Â Â Â Â Â onClick: () => showLocalListForImport()
Â Â Â Â },
Â Â Â Â {
Â Â Â Â Â Â text: 'â¨‰',Â 
Â Â Â Â Â Â class: 'btn-confirm',
Â Â Â Â Â Â onClick: () => {}
Â Â Â Â }
Â Â ], 'importType');
}
function showLocalListForImport() {
Â Â const lists = [];
Â Â for (let i = 0; i < localStorage.length; i++) {
Â Â Â Â const key = localStorage.key(i);

Â Â Â Â // ä½ å¯ä»¥åŠ è‡ªå·±çš„ key æ¢ä»¶ï¼Œä¾‹å¦‚ key === 'memoryData' æˆ–å…¶å®ƒ
Â Â Â Â if (key.startsWith('chooseHelperList_') || key === 'memoryData') {
Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â const data = JSON.parse(localStorage.getItem(key));

Â Â Â Â Â Â Â Â // æ ¼å¼1ï¼šæœ‰ items é™£åˆ—
Â Â Â Â Â Â Â Â if (data && Array.isArray(data.items)) {
Â Â Â Â Â Â Â Â Â Â lists.push({
Â Â Â Â Â Â Â Â Â Â Â Â key,
Â Â Â Â Â Â Â Â Â Â Â Â name: data.name || key,
Â Â Â Â Â Â Â Â Â Â Â Â items: data.items
Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â }Â 
Â Â Â Â Â Â Â Â // æ ¼å¼2ï¼škey-value mapï¼Œæ¯å€‹ key ä¸€å€‹ array
Â Â Â Â Â Â Â Â else if (data && typeof data === 'object') {
Â Â Â Â Â Â Â Â Â Â for (const k in data) {
Â Â Â Â Â Â Â Â Â Â Â Â if (Array.isArray(data[k])) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â lists.push({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â key: key + ':' + k, // key:memoryData:æ™šé¤åƒä»€éº¼
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â name: k,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â items: data[k]
Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â } catch (e) {}
Â Â Â Â }
Â Â }

Â Â if (lists.length === 0) {
Â Â Â Â showModal('æ‰¾ä¸åˆ°ä»»ä½•æœ¬åœ°æ¸…å–®ï¼', [
Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â ], 'error');
Â Â Â Â return;
Â Â }

Â Â // å½ˆçª—è®“ç”¨æˆ¶é¸
Â Â const content = `<div style="max-height:320px;overflow:auto;text-align:left;">
Â Â Â Â ${lists.map((list, idx) => `
Â Â Â Â Â Â <div style="margin-bottom:8px;padding:8px 0;">
Â Â Â Â Â Â Â Â <b>${list.name}</b>
Â Â Â Â Â Â Â Â <span style="color:#888;font-size:0.93em;">ï¼ˆ${list.items.length} é …ï¼‰</span>
Â Â Â Â Â Â Â Â <button class="btn-primary" style="margin-left:12px;padding:2px 14px;font-size:14px;" onclick="window._importLocalList('${list.key}')">åŒ¯å…¥</button>
Â Â Â Â Â Â </div>
Â Â Â Â `).join('')}
Â Â </div>`;

Â Â showModal(content, [
Â Â Â Â { text: 'å–æ¶ˆ', class: 'btn-primary', onClick: () => {} }
Â Â ], 'localListImport');

Â Â // è‡¨æ™‚æ› windowï¼Œåš key-value å–å‡º
Â Â window._importLocalList = function(fullKey) {
Â Â Â Â let key = fullKey, subkey = null;
Â Â Â Â if (fullKey.includes(':')) {
Â Â Â Â Â Â [key, subkey] = fullKey.split(':');
Â Â Â Â }
Â Â Â Â try {
Â Â Â Â Â Â const data = JSON.parse(localStorage.getItem(key));
Â Â Â Â Â Â let items = [];
Â Â Â Â Â Â if (subkey) {
Â Â Â Â Â Â Â Â items = data[subkey];
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â items = data.items;
Â Â Â Â Â Â }
Â Â Â Â Â Â if (Array.isArray(items) && items.length > 0) {
Â Â Â Â Â Â Â Â importItemsFromArray(items);
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â showModal('æ¸…å–®æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•åŒ¯å…¥', [
Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â }
Â Â Â Â } catch {
Â Â Â Â Â Â showModal('åŒ¯å…¥å¤±æ•—', [
Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â ], 'error');
Â Â Â Â }
Â Â Â Â closeAllModals();
Â Â }
}

async function importItemsFromArray(items) {
Â Â Â Â logDebug("importItemsFromArray: Importing array items");
Â Â Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â Â Â if (!Array.isArray(items) || items.length === 0) {
Â Â Â Â Â Â showModal('æ²’æœ‰å¯åŒ¯å…¥çš„é …ç›®ï¼', [
Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â return;
Â Â Â Â }
Â Â Â Â const listRef = db.ref('rooms/' + roomId + '/list');
Â Â Â Â const importBtn = document.querySelector('#multiPage .btn-primary[onclick="chooseImportType()"]');
Â Â Â Â if (importBtn) {
Â Â Â Â Â Â importBtn.disabled = true;
Â Â Â Â Â Â importBtn.innerHTML = '<span class="spin-animation">â³</span> åŒ¯å…¥ä¸­...';
Â Â Â Â }
Â Â Â Â let attempt = 0, maxRetries = 3;
Â Â Â Â while (attempt < maxRetries) {
Â Â Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â Â Â Â Â const snapshot = await listRef.once('value');
Â Â Â Â Â Â Â Â Â Â Â Â let list = snapshot.val() || [];
Â Â Â Â Â Â Â Â Â Â Â Â list = list.concat(items);
Â Â Â Â Â Â Â Â Â Â Â Â await listRef.set(list);
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`importItemsFromArray: Imported ${items.length} items`);
Â Â Â Â Â Â Â Â Â Â Â Â if (importBtn) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â importBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â importBtn.innerHTML = 'åŒ¯å…¥';
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â showModal('å·²åŒ¯å…¥æœ¬åœ°æ¸…å–®', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â ], 'success');
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â Â attempt++;
Â Â Â Â Â Â Â Â Â Â Â Â logDebug(`importItemsFromArray: Error on attempt ${attempt}: ${error.message}`);
Â Â Â Â Â Â Â Â Â Â Â Â if (attempt === maxRetries) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â showModal('åŒ¯å…¥é …ç›®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ], 'error');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (importBtn) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â importBtn.disabled = false;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â importBtn.innerHTML = 'åŒ¯å…¥';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â await new Promise(resolve => setTimeout(resolve, 1000));
Â Â Â Â Â Â Â Â }
Â Â Â Â }
}

function showCertificate(result) {
Â Â // å…ˆéš±è—æ±ºå®šæ–¹å¼
Â Â document.getElementById('decideModeDisplay').style.display = 'none';
Â Â // å–å¾—æ—¥æœŸ
Â Â const date = new Date();
Â Â const dateStr = `${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥`;
Â Â const roomId = localStorage.getItem('currentRoomId');
Â Â db.ref(`rooms/${roomId}/participants`).once('value').then(snap => {
Â Â Â Â const membersArr = Object.values(snap.val() || {}).map(u => u.name);
Â Â Â Â db.ref(`rooms/${roomId}/decisionMode`).once('value').then(modeSnap => {
Â Â Â Â Â Â const mode = modeSnap.val() || 'ä¸€æŠ½å…¥é­‚';
Â Â Â Â Â Â // å¡«å¯«æ‰€æœ‰è³‡æ–™
Â Â Â Â Â Â renderCertificateCanvas({
Â Â Â Â Â Â Â Â title: 'æŠ½ç±¤æ±ºè­°è­‰æ˜æ›¸',
Â Â Â Â Â Â Â Â date: dateStr,
Â Â Â Â Â Â Â Â membersArr,
Â Â Â Â Â Â Â Â mode,
Â Â Â Â Â Â Â Â result,
Â Â Â Â Â Â Â Â statement: [
Â Â Â Â Â Â Â Â Â Â "ã€å…±åŒè²æ˜ã€‘",
Â Â Â Â Â Â Â Â Â Â "æœ¬æ¬¡æŠ½ç±¤çµæœå³ç‚ºæœ€çµ‚æ±ºè­°ï¼Œ",
Â Â Â Â Â Â Â Â Â Â "åƒèˆ‡è€…çš†æ‰¿è«¾å…±åŒéµå®ˆï¼Œ",
Â Â Â Â Â Â Â Â Â Â "ä¸å¾—ä»»æ„æ›´æ”¹æˆ–æ‹’çµ•åŸ·è¡Œã€‚"
Â Â Â Â Â Â Â Â ]
Â Â Â Â Â Â });
Â Â Â Â });
Â Â });
}

function renderCertificateCanvas(data) {
Â Â const targetDiv = document.getElementById('resultArea');
Â Â targetDiv.innerHTML = '';

Â Â // çç‹€åº•åœ–å°ºå¯¸
Â Â const W = 640, H = 452;
Â Â const canvas = document.createElement('canvas');
Â Â canvas.width = W;
Â Â canvas.height = H;
Â Â const ctx = canvas.getContext('2d');

Â Â // å­—é«”
Â Â const fontFamily = '"æ¨™æ¥·é«”","DFKai-SB","BiauKai","Noto Serif TC",serif';

Â Â // å€å¡Šé…ç½®
Â Â const titleY = 62;
Â Â const infoStartY = 110;
Â Â const infoGapY = 37;
Â Â const membersBlockY = 147;
Â Â const resultBlockY = 235;
Â Â const statementBlockY = 340; // å…±åŒè²æ˜å€å†å¾€ä¸‹æ‹‰

Â Â // èƒŒæ™¯åœ–
Â Â const img = new Image();
Â Â img.crossOrigin = 'anonymous';
Â Â img.src = 'https://cdn.jsdelivr.net/gh/a355226/choosehelper@main/paper.png';

Â Â img.onload = function () {
Â Â Â Â ctx.drawImage(img, 0, 0, W, H);

Â Â Â Â // 1. æŠ¬é ­
Â Â Â Â ctx.font = `bold 32px ${fontFamily}`;
Â Â Â Â ctx.fillStyle = '#8a3605';
Â Â Â Â ctx.textAlign = 'center';
Â Â Â Â ctx.shadowColor = "#ffeedd";
Â Â Â Â ctx.shadowBlur = 8;
Â Â Â Â ctx.fillText(data.title, W / 2, titleY);
Â Â Â Â ctx.shadowBlur = 0;

Â Â Â Â // 2. æ—¥æœŸ
Â Â Â Â ctx.font = `21px ${fontFamily}`;
Â Â Â Â ctx.fillStyle = '#111';
Â Â Â Â ctx.textAlign = 'left';
Â Â Â Â ctx.fillText(`ğŸ—“ï¸ æ—¥æœŸï¼š${data.date}`, 60, infoStartY);

Â Â Â Â // 3. æ±ºå®šæ–¹å¼
Â Â Â Â ctx.font = `21px ${fontFamily}`;
Â Â Â Â ctx.fillStyle = '#111';
Â Â Â Â ctx.textAlign = 'right';
Â Â Â Â ctx.fillText(`æŠ½ç±¤æ–¹å¼ï¼š${data.mode}`, W - 60, infoStartY);

Â Â Â Â // 4. åƒèˆ‡è€…å€å¡Šï¼ˆè‡ªå‹•è¡Œåˆ†å‰²ï¼†è‡ªå‹•ç¸®å­—ï¼‰
Â Â Â Â ctx.textAlign = 'center';
Â Â Â Â ctx.fillStyle = '#111';
Â Â Â Â let membersText = `æœ¬æ¬¡åƒèˆ‡è€…ï¼š${data.membersArr.join('ã€')}`;
Â Â Â Â let memberFontSize = 23, minFont = 13;
Â Â Â Â // åƒèˆ‡è€…é•·åº¦è‡ªå‹•ç¸®å­—
Â Â Â Â ctx.font = `${memberFontSize}px ${fontFamily}`;
Â Â Â Â while (memberFontSize > minFont && ctx.measureText(membersText).width > W - 80) {
Â Â Â Â Â Â memberFontSize--;
Â Â Â Â Â Â ctx.font = `${memberFontSize}px ${fontFamily}`;
Â Â Â Â }
Â Â Â Â // å¤šè¡Œåˆ†å‰²
Â Â Â Â let lines = [];
Â Â Â Â let maxLineW = W - 80;
Â Â Â Â let names = data.membersArr;
Â Â Â Â ctx.font = `${memberFontSize}px ${fontFamily}`;
Â Â Â Â let current = "æœ¬æ¬¡åƒèˆ‡è€…ï¼š";
Â Â Â Â for (let i = 0; i < names.length; i++) {
Â Â Â Â Â Â let next = (current.endsWith('ï¼š') ? current : current + 'ã€') + names[i];
Â Â Â Â Â Â if (ctx.measureText(next).width > maxLineW && current !== "æœ¬æ¬¡åƒèˆ‡è€…ï¼š") {
Â Â Â Â Â Â Â Â lines.push(current);
Â Â Â Â Â Â Â Â current = names[i];
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â current = next;
Â Â Â Â Â Â }
Â Â Â Â }
Â Â Â Â lines.push(current);

Â Â Â Â for (let i = 0; i < lines.length; i++) {
Â Â Â Â Â Â ctx.fillText(lines[i], W / 2, membersBlockY + i * memberFontSize * 1.24);
Â Â Â Â }

Â Â Â Â // 5. æ±ºè­°çµæœï¼ˆç´…è‰²å¤§å­—ï¼Œç·šæ¢ç´°ï¼Œæ¸…æ™°ï¼ï¼‰
Â Â Â Â ctx.save();
Â Â Â Â // ä¸»æ¨™
Â Â Â Â ctx.font = `bold 32px ${fontFamily}`;
Â Â Â Â ctx.textAlign = 'center';
Â Â Â Â ctx.fillStyle = "#b15906";
Â Â Â Â ctx.fillText(`ğŸ‰ æœ¬æ¬¡æ±ºè­°çµæœï¼š`, W / 2, resultBlockY);

Â Â Â Â // æ±ºè­°çµæœå¤§ç´…å­—ï¼ˆå¾®ç™½å…‰ï¼Œç„¡ç²—æé‚Šï¼‰
Â Â Â Â ctx.font = `bold 54px ${fontFamily}`;
Â Â Â Â ctx.shadowColor = "#fff";
Â Â Â Â ctx.shadowBlur = 5;
Â Â Â Â ctx.fillStyle = "#cf2d3a";
Â Â Â Â ctx.fillText(data.result, W / 2, resultBlockY + 56);
Â Â Â Â ctx.shadowBlur = 0;
Â Â Â Â ctx.restore();

Â Â Â Â // 6. å…±åŒè²æ˜ï¼ˆç¸®å°ï¼Œä¸æ¶ç„¦ï¼‰
Â Â Â Â ctx.font = `17px ${fontFamily}`;
Â Â Â Â ctx.fillStyle = '#555';
Â Â Â Â ctx.textAlign = 'center';
Â Â Â Â let statementGapY = 22;
Â Â Â Â for (let i = 0; i < data.statement.length; i++) {
Â Â Â Â Â Â ctx.fillText(data.statement[i], W / 2, statementBlockY + i * statementGapY);
Â Â Â Â }
Â Â };

Â Â targetDiv.appendChild(canvas);
}

function showVoteCountdown(duration = 25, startTime = Date.now()) {
Â Â Â Â hideVoteCountdown();
Â Â Â Â let remain = duration - Math.floor((Date.now() - startTime) / 1000);
Â Â Â Â if (remain < 0) remain = 0;

Â Â Â Â let el = document.getElementById('global-vote-countdown');
Â Â Â Â if (!el) {
Â Â Â Â Â Â Â Â el = document.createElement('div');
Â Â Â Â Â Â Â Â el.id = 'global-vote-countdown';
Â Â Â Â Â Â Â Â el.style.position = 'fixed';
Â Â Â Â Â Â Â Â el.style.top = '18px';
Â Â Â Â Â Â Â Â el.style.left = '50%';
Â Â Â Â Â Â Â Â el.style.transform = 'translateX(-50%)';
Â Â Â Â Â Â Â Â el.style.width = '270px';
Â Â Â Â Â Â Â Â el.style.zIndex = 99999;
Â Â Â Â Â Â Â Â el.style.background = 'rgba(255,255,255,0.96)';
Â Â Â Â Â Â Â Â el.style.borderRadius = '15px';
Â Â Â Â Â Â Â Â el.style.boxShadow = '0 2px 18px #3db8c422';
Â Â Â Â Â Â Â Â el.style.display = 'flex';
Â Â Â Â Â Â Â Â el.style.alignItems = 'center';
Â Â Â Â Â Â Â Â el.style.justifyContent = 'center';
Â Â Â Â Â Â Â Â el.style.padding = '7px 14px';
Â Â Â Â Â Â Â Â el.innerHTML = `
Â Â Â Â Â Â Â Â Â Â Â Â <div style="flex:1;display:flex;align-items:center;">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â <div style="flex:1;background:#e0f4ff;height:10px;border-radius:8px;overflow:hidden;position:relative;">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <div id="vote-countdown-bar" style="height:100%;background:linear-gradient(90deg,#3db8c4 60%,#fc806d 100%);border-radius:8px;width:100%;transition:width 0.25s;"></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â Â Â Â Â <div style="margin-left:12px;font-size:1.12em;font-weight:bold;color:#fc806d;">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span id="vote-countdown-num">${remain}</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span style="font-size:0.85em;color:#999;font-weight:500;">ç§’</span>
Â Â Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â `;
Â Â Â Â Â Â Â Â document.body.appendChild(el);
Â Â Â Â Â Â Â Â setTimeout(() => { el.style.opacity = 1; }, 0);
Â Â Â Â }

Â Â Â Â let interval = setInterval(() => {
Â Â Â Â Â Â Â Â remain = duration - Math.floor((Date.now() - startTime) / 1000);
Â Â Â Â Â Â Â Â if (remain < 0) remain = 0;
Â Â Â Â Â Â Â Â let n = document.getElementById('vote-countdown-num');
Â Â Â Â Â Â Â Â let bar = document.getElementById('vote-countdown-bar');
Â Â Â Â Â Â Â Â if (n) n.textContent = remain;
Â Â Â Â Â Â Â Â if (bar) bar.style.width = (remain / duration * 100) + '%';
Â Â Â Â Â Â Â Â if (remain <= 0) {
Â Â Â Â Â Â Â Â Â Â Â Â clearInterval(interval);
Â Â Â Â Â Â Â Â Â Â Â Â hideVoteCountdown();
Â Â Â Â Â Â Â Â }
Â Â Â Â }, 300);
Â Â Â Â window._voteCountdownInterval = interval;
}


function hideVoteCountdown() {
Â Â let el = document.getElementById('global-vote-countdown');
Â Â if (el) {
Â Â Â Â el.style.opacity = 0;
Â Â Â Â setTimeout(() => el.remove(), 350);
Â Â }
Â Â if (window._voteCountdownInterval) {
Â Â Â Â clearInterval(window._voteCountdownInterval);
Â Â Â Â window._voteCountdownInterval = null;
Â Â }
}


</script>
</head>
<body>
<h1><img src="https://cdn.jsdelivr.net/gh/a355226/choosehelper@main/icon.png" alt="icon" width="32"> æ±ºç­–å°å¹«æ‰‹</h1>
<div class="page active" id="setupPage">
<div class="exit-btn" onclick="leaveRoom()" title="é›¢é–‹"></div>
Â Â <div class="header-row" style="justify-content: flex-end;">
Â Â </div>
Â Â <h2>ğŸ  å»ºç«‹ / åŠ å…¥æˆ¿é–“</h2>
Â Â <input type="text" id="roomNameInput" placeholder="æˆ¿é–“åç¨±" />
Â Â <input type="text" id="verificationCodeInput" placeholder="é©—è­‰ç¢¼ï¼ˆæ–°æˆ¿é–“å…å¡«ï¼‰" />
Â Â <input type="text" id="userNameInput" placeholder="ä½ çš„åç¨±" />
Â Â <button class="btn-primary" onclick="createRoom()" style="margin-top: 26px;">å»ºç«‹ / åŠ å…¥</button>

</div>
<div class="page" id="multiPage">
<div class="exit-btn" onclick="leaveRoom()" title="é›¢é–‹"></div>
Â Â <div class="header-row" style="display: flex; justify-content: space-between; align-items: center;">
Â Â <div>
Â Â Â Â <span id="roomNameDisplay" style="font-weight:bold; font-size:1.2em; letter-spacing:1px;"></span>
Â Â Â Â <span id="roomCodeDisplay" style="color:#888; font-size:0.95em; margin-left: 5px;"></span>
Â Â </div>
Â Â <button class="btn-primary" style="padding:6px 14px; font-size:15px; background:#2894FF;" onclick="shareRoom()">åˆ†äº«</button>

</div>

Â Â <div><strong id="participantCount">åƒèˆ‡è€…(0äºº)ï¼š </strong>
Â Â Â Â <div id="participantContainer" class="item-container"></div>
Â Â </div>
Â Â <div style="margin-top: 10px; text-align:left;">
Â Â Â Â <button class="btn-primary" onclick="chooseDecisionMode()">æ±ºå®šæ–¹å¼</button>
Â Â Â Â <span id="selectedMode" class="selected-mode-tag"></span>

Â Â </div>
Â Â <div style="margin-top: 20px;"><strong>ğŸ“ƒ æ¸…å–®é …ç›®ï¼š</strong>
Â Â Â Â <div id="listContainer" class="item-container"></div>
Â Â Â Â <input type="text" id="itemInput" placeholder="è¼¸å…¥é …ç›®" onkeypress="if(event.key==='Enter') addItem();" />
Â Â Â Â <div style="display:flex; gap:6px; margin-top:4px;">
Â Â Â Â Â Â <button class="btn-primary" onclick="addItem()">æ–°å¢é …ç›®</button>
Â Â Â Â Â Â <button class="btn-primary" onclick="chooseImportType()">åŒ¯å…¥</button>

Â Â Â Â </div>
Â Â Â Â <div style="margin-top:30px;">
Â Â Â Â Â Â <button class="btn-confirm-red" onclick="requestConfirmation()">æˆ‘åŒæ„æ­¤æ¸…å–®</button>
Â Â Â Â </div>
Â Â </div>
Â Â <div id="multiDebugBox" class="debug-box"></div>
</div>
<div class="page" id="decidePage">
<div class="exit-btn" onclick="leaveRoom()" title="é›¢é–‹"></div>

Â Â <div class="header-row" style="align-items:flex-start; justify-content:space-between;">
Â Â <div style="display:flex; flex-direction:column; align-items:flex-start;">
<div style="display:inline-flex; align-items:center;">
Â Â <span id="decideRoomNameDisplay" style="font-weight:bold; font-size:1.25em;"></span>
Â Â <span id="decideRoomCodeDisplay" style="color:#888; font-size:1em; margin-left:8px;"></span>
</div>


Â Â Â Â <button class="btn-primary" style="padding:3px 10px; font-size:12px; margin-top:8px; border-radius:8px;" onclick="requestReedit()">â† é‡æ–°ç·¨è¼¯</button>

Â Â </div>
Â Â <div>
Â Â </div>
</div>

Â Â <div>
Â Â Â Â <strong id="decideParticipantCount">åƒèˆ‡è€…(0äºº)ï¼š</strong>
Â Â Â Â <div id="decideParticipantContainer" class="item-container"></div>
Â Â </div>
Â Â <div style="text-align:center; margin-top: 30px;">
Â Â Â Â <button class="btn-draw" onclick="startDraw()">ğŸ² é–‹å§‹æŠ½ç±¤</button>
<div id="decideModeDisplay"></div>
Â Â Â Â <div id="resultArea" style="font-size: 2em; margin-top: 20px;"></div>
Â Â </div>
Â Â <div id="decideDebugBox" class="debug-box"></div>
</div>
</body>
</html>