
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>å¤šäººé¸æ“‡å°å¹«æ‰‹ - å»ºç«‹æˆ¿é–“</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link rel="icon" type="image/png" sizes="32x32" href="icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="icon.png">
<link rel="manifest" href="manifest.json">
<style>
  body {font-family: "Segoe UI", sans-serif; background-color: #f0f9ff; margin: 0; padding: 0;}
  h1 {text-align: center; padding: 20px; color: #2c3e50; margin: 0;}
  .page {display: none; padding: 20px; max-width: 600px; margin: auto;}
  .page.active {display: block;}
  .btn-primary {background-color: #3db8c4; color: white; border: none; border-radius: 8px; padding: 10px 16px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s ease;}
  .btn-primary:hover {background-color: #35a4af;}
  .btn-confirm {background-color: #2c3e50; color: white; border: none; border-radius: 8px; padding: 10px 16px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s ease;}
  .btn-confirm:hover {background-color: #1e2a38;}
  input {padding: 10px; font-size: 16px; margin: 8px 0; border-radius: 5px; border: 1px solid #ccc; width: 100%; box-sizing: border-box;}
  .item-container {display: flex; flex-wrap: wrap; gap: 6px; max-height: calc(1.8em * 3 + 20px); overflow-y: auto; padding: 4px; background: #ffffffaa; border-radius: 8px;}
  .item-box {background: #e0f4ff; border-radius: 16px; padding: 6px 10px; font-size: 14px; white-space: nowrap; max-width: 150px; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center;}
  .remove-btn {background: none; border: none; color: #c0392b; font-size: 16px; cursor: pointer; margin-left: 6px; flex-shrink: 0;}
  .header-row {display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;}
  .modal {position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 9999;}
  .modal-content {background: white; max-width: 90%; max-height: 80%; overflow-y: auto; padding: 20px; border-radius: 8px; text-align: center;}
  .hidden {display: none;}
</style>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyBUbKgC4P7wGFQqZZmgJU890qOe_4yC9kA",
    authDomain: "choosehel.firebaseapp.com",
    databaseURL: "https://choosehel-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "choosehel",
    storageBucket: "choosehel.appspot.com",
    messagingSenderId: "116763876894",
    appId: "1:116763876894:web:1662b36ef2fa815863d80f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let userId;

function createRoom() {
  const roomName = document.getElementById('roomNameInput').value.trim();
  const userName = document.getElementById('userNameInput').value.trim();
  if (!roomName || !userName) {
    alert('è«‹è¼¸å…¥æˆ¿é–“åç¨±å’Œä½ çš„åç¨±');
    return;
  }
  const roomId = encodeURIComponent(roomName);
  userId = 'user_' + Math.random().toString(36).substr(2, 9);
  const roomRef = db.ref('rooms/' + roomId);

  roomRef.once('value').then(snapshot => {
    if (!snapshot.exists()) {
      roomRef.set({
        name: roomName,
        creator: userName,
        list: [],
        participants: {}
      });
    }
    roomRef.child('participants/' + userId).set({ name: userName });
    localStorage.setItem('currentRoomId', roomId);
    localStorage.setItem('currentUserId', userId);
    document.getElementById('setupPage').classList.remove('active');
    document.getElementById('multiPage').classList.add('active');
    document.getElementById('roomNameDisplay').textContent = `æˆ¿é–“ï¼š${decodeURIComponent(roomId)}`;
    loadRoomData(roomId);
    listenConfirmation(roomId);
  });
}

function showModal(content, buttons) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  const modalContent = document.createElement('div');
  modalContent.className = 'modal-content';
  modalContent.innerHTML = `<p style="font-size:18px;">${content}</p>`;
  buttons.forEach(btn => {
    const button = document.createElement('button');
    button.className = btn.class || 'btn-primary';
    button.textContent = btn.text;
    button.onclick = () => {
      modal.remove();
      btn.onClick();
    };
    modalContent.appendChild(button);
  });
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
}

function loadRoomData(roomId) {
  const roomRef = db.ref('rooms/' + roomId);
  const participantContainer = document.getElementById('participantContainer');
  const listContainer = document.getElementById('listContainer');

  roomRef.child('participants').on('value', snapshot => {
    const data = snapshot.val() || {};
    participantContainer.innerHTML = '';
    Object.values(data).forEach(p => {
      const div = document.createElement('div');
      div.className = 'item-box';
      div.textContent = p.name;
      participantContainer.appendChild(div);
    });
  });

  roomRef.child('list').on('value', snapshot => {
    const items = snapshot.val() || [];
    listContainer.innerHTML = '';
    items.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'item-box';
      const span = document.createElement('span');
      span.textContent = item;
      const btn = document.createElement('button');
      btn.textContent = 'âœ•';
      btn.className = 'remove-btn';
      btn.onclick = () => removeItem(index);
      div.appendChild(span);
      div.appendChild(btn);
      listContainer.appendChild(div);
    });
  });
roomRef.child('decisionMode').on('value', snapshot => {
  const mode = snapshot.val() || '';
  document.getElementById('selectedMode').textContent = mode ? `å·²é¸æ“‡ï¼š${mode}` : '';
  const decideModeDisplay = document.getElementById('decideModeDisplay');
  if (decideModeDisplay) decideModeDisplay.textContent = mode ? `æ±ºå®šæ–¹å¼ï¼š${mode}` : '';
});

}

function addItem() {
  const roomId = localStorage.getItem('currentRoomId');
  const input = document.getElementById('itemInput');
  const value = input.value.trim();
  if (!value) return;
  const listRef = db.ref('rooms/' + roomId + '/list');
  listRef.once('value').then(snapshot => {
    let list = snapshot.val() || [];
    list.push(value);
    listRef.set(list);
  });
  input.value = '';
}

function removeItem(index) {
  const roomId = localStorage.getItem('currentRoomId');
  const listRef = db.ref('rooms/' + roomId + '/list');
  listRef.once('value').then(snapshot => {
    let list = snapshot.val() || [];
    list.splice(index, 1);
    listRef.set(list);
  });
}

function importItems() {
  const roomId = localStorage.getItem('currentRoomId');
  const text = prompt('è«‹è²¼ä¸Šè¦åŒ¯å…¥çš„é …ç›®ï¼ˆJSON æˆ–æ¯è¡Œä¸€é …ï¼‰ï¼š');
  if (!text) return;
  let items = [];
  try {
    const parsed = JSON.parse(text);
    if (parsed.items) items = parsed.items;
    else throw new Error();
  } catch {
    items = text.split('\n').map(s => s.trim()).filter(Boolean);
  }
  if (items.length === 0) return;
  const listRef = db.ref('rooms/' + roomId + '/list');
  listRef.once('value').then(snapshot => {
    let list = snapshot.val() || [];
    list = list.concat(items);
    listRef.set(list);
  });
}

function shareRoom() {
  const roomId = localStorage.getItem('currentRoomId');
  const url = `${location.origin}${location.pathname}?room=${roomId}`;

  // å»ºç«‹ modal
  const modal = document.createElement('div');
  modal.className = 'modal';
  const modalContent = document.createElement('div');
  modalContent.className = 'modal-content';

  const title = document.createElement('p');
  title.textContent = 'è«‹é¸æ“‡åˆ†äº«æ–¹å¼';
  title.style.fontSize = '18px';
  modalContent.appendChild(title);

  // åˆ†äº«æŒ‰éˆ•
  const shareBtn = document.createElement('button');
  shareBtn.textContent = 'ğŸ“¤ åˆ†äº«';
  shareBtn.className = 'btn-primary';
  shareBtn.style.margin = '8px';
  shareBtn.onclick = () => {
    if (navigator.share) {
      navigator.share({
        title: 'åŠ å…¥æˆ‘çš„é¸æ“‡æˆ¿é–“',
        text: 'é»æ“Šå¿«é€ŸåŠ å…¥æˆ¿é–“ï¼',
        url
      }).catch(err => alert('åˆ†äº«å¤±æ•—: ' + err));
    } else {
      alert('æ­¤è£ç½®ä¸æ”¯æ´ç›´æ¥åˆ†äº«åŠŸèƒ½');
    }
    modal.remove();
  };
  modalContent.appendChild(shareBtn);

  // è¤‡è£½æŒ‰éˆ•
  const copyBtn = document.createElement('button');
  copyBtn.textContent = 'ğŸ“‹ è¤‡è£½é€£çµ';
  copyBtn.className = 'btn-primary';
  copyBtn.style.margin = '8px';
  copyBtn.onclick = () => {
    navigator.clipboard.writeText(url)
      .then(() => alert('å·²è¤‡è£½é€£çµï¼Œå¯ç›´æ¥è²¼çµ¦æœ‹å‹ï¼'))
      .catch(err => alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½'));
    modal.remove();
  };
  modalContent.appendChild(copyBtn);

  // å–æ¶ˆæŒ‰éˆ•
  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'âŒ å–æ¶ˆ';
  cancelBtn.className = 'btn-confirm';
  cancelBtn.style.margin = '8px';
  cancelBtn.onclick = () => {
    modal.remove();
  };
  modalContent.appendChild(cancelBtn);

  modal.appendChild(modalContent);
  document.body.appendChild(modal);
}


// åŒæ„æ©Ÿåˆ¶
function listenConfirmation(roomId) {
  const confirmRef = db.ref(`rooms/${roomId}/confirm`);
  confirmRef.on('value', snapshot => {
    const data = snapshot.val();
    if (data && data.active) {
      showModal('ä½ æ˜¯å¦åŒæ„æ­¤æ¸…å–®ï¼Ÿ', [
        { text: 'åŒæ„', class: 'btn-confirm', onClick: () => confirmRef.child('responses').child(userId).set(true) },
        { text: 'ä¸åŒæ„', class: 'btn-primary', onClick: () => confirmRef.set(null) }
      ]);
    }
  });
}

function requestConfirmation() {
  const roomId = localStorage.getItem('currentRoomId');
  const roomRef = db.ref(`rooms/${roomId}`);
  roomRef.child('participants').once('value').then(snapshot => {
    const participants = snapshot.val() || {};
    const total = Object.keys(participants).length;
    const confirmRef = roomRef.child('confirm');
    confirmRef.set({ active: true, responses: {} });
    confirmRef.child('responses').on('value', snap => {
      const responses = snap.val() || {};
      if (Object.keys(responses).length === total) {
        confirmRef.off();
        confirmRef.set(null);
document.getElementById('multiPage').classList.remove('active');
document.getElementById('decidePage').classList.add('active');
document.getElementById('decideRoomNameDisplay').textContent = document.getElementById('roomNameDisplay').textContent;


        // âš ï¸ TODO: å¯¦éš›å°å‘ä¸‹ä¸€æ­¥é é¢æˆ–è§¸ç™¼æŠ½ç±¤ï¼Œå¯æ¥ä½ çš„å‹•ç•«ç¨‹å¼
      }
    });
  });
}
</script>
</head>
<body>
<h1>å¤šäººé¸æ“‡å°å¹«æ‰‹</h1>
<div class="page active" id="setupPage">
<div class="header-row" style="justify-content: flex-end;">
    <button class="btn-primary" style="padding:6px 12px; font-size:14px;" onclick="leaveRoom()">ğŸƒ é›¢é–‹</button>
</div>

  <h2>å»ºç«‹ / åŠ å…¥æˆ¿é–“</h2>
  <input type="text" id="roomNameInput" placeholder="æˆ¿é–“åç¨±" />
  <input type="text" id="userNameInput" placeholder="ä½ çš„åç¨±" />
  <button class="btn-primary" onclick="createRoom()">å»ºç«‹ / åŠ å…¥</button>
</div>
<div class="page" id="multiPage">


<div class="header-row">
    <span id="roomNameDisplay" style="font-weight:bold;"></span>
    <button class="btn-primary" style="padding:6px 12px; font-size:14px;" onclick="shareRoom()">åˆ†äº«</button>
    <button class="btn-primary" style="padding:6px 12px; font-size:14px;" onclick="leaveRoom()">ğŸƒ é›¢é–‹</button>
</div>

  <div><strong>åƒèˆ‡è€…ï¼š</strong>
    <div id="participantContainer" class="item-container"></div>
  </div>
<div style="text-align:center; margin-bottom:10px;">
  <button class="btn-primary" onclick="chooseDecisionMode()">æ±ºå®šæ–¹å¼</button>
  <span id="selectedMode" style="margin-left:8px; font-weight:bold; color:#2c3e50;"></span>
</div>
  <div style="margin-top: 20px;"><strong>ğŸ“ƒ æ¸…å–®é …ç›®ï¼š</strong>
    <div id="listContainer" class="item-container"></div>
    <input type="text" id="itemInput" placeholder="è¼¸å…¥é …ç›®ä¸¦æŒ‰ Enter" onkeypress="if(event.key==='Enter') addItem();" />
    <div style="display:flex; gap:6px; margin-top:4px;">
      <button class="btn-primary" onclick="addItem()">æ–°å¢é …ç›®</button>
      <button class="btn-primary" onclick="importItems()">åŒ¯å…¥</button>
    </div>
    <div style="margin-top:10px;">
      <button class="btn-confirm" onclick="requestConfirmation()">æˆ‘åŒæ„æ­¤æ¸…å–®</button>
    </div>
  </div>
</div>
<div class="page" id="decidePage">
<div class="header-row">
  <span id="decideRoomNameDisplay" style="font-weight:bold;"></span>
  <span id="decideModeDisplay" style="margin-left:10px; font-weight:bold; color:#2c3e50;"></span>
</div>

  <div style="text-align:center; margin-top: 30px;">
    <button class="btn-primary" onclick="startDraw()">ğŸ² é–‹å§‹æŠ½ç±¤</button>
    <div id="resultArea" style="font-size: 2em; margin-top: 20px;"></div>
  </div>
</div>
<script>
window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('setupPage').classList.add('active');
});
function startDraw() {
  const roomId = localStorage.getItem('currentRoomId');
  const finalResultRef = db.ref(`rooms/${roomId}/finalResult`);
  const listRef = db.ref('rooms/' + roomId + '/list');
  const modeRef = db.ref('rooms/' + roomId + '/decisionMode');

  // å…ˆæª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æœ€çµ‚çµæœ
  finalResultRef.once('value').then(finalSnap => {
    const existingResult = finalSnap.val();
    if (existingResult) {
      showModal(`âš ï¸ æœ¬æ¬¡æŠ½ç±¤å·²å®Œæˆï¼Œçµæœç‚ºï¼š${existingResult}`, [
        { text: 'å¥½çš„', class: 'btn-confirm', onClick: () => {} }
      ]);
      return; // é˜»æ­¢ç¹¼çºŒæŠ½ç±¤
    }

    // è‹¥ç„¡çµæœï¼Œé€²è¡ŒæŠ½ç±¤æµç¨‹
    Promise.all([
      listRef.once('value'),
      modeRef.once('value')
    ]).then(([listSnap, modeSnap]) => {
      const items = listSnap.val() || [];
      const mode = modeSnap.val() || 'ä¸€æŠ½å…¥é­‚'; // é è¨­ä¸€æŠ½å…¥é­‚

      if (items.length === 0) {
        alert('âš ï¸ ç›®å‰æ²’æœ‰å¯æŠ½ç±¤çš„é …ç›®');
        return;
      }

      const spinList = [];
      for (let i = 0; i < 60; i++) {
        spinList.push(items[Math.floor(Math.random() * items.length)]);
      }
      const finalItem = items[Math.floor(Math.random() * items.length)];
      spinList.push(finalItem);

      const resultArea = document.getElementById('resultArea');
      resultArea.textContent = 'ğŸ° æŠ½ç±¤ä¸­...';

      let index = 0;
      const interval = setInterval(() => {
        resultArea.textContent = spinList[index];
        index++;
        if (index >= spinList.length) {
          clearInterval(interval);

          if (mode === 'ä¸€æŠ½å…¥é­‚') {
            db.ref(`rooms/${roomId}/finalResult`).set(finalItem); // è¨˜éŒ„æœ€çµ‚çµæœ
            showFinalResult(finalItem);
          } else if (mode === 'å¤šæ•¸æ±º' || mode === 'å…±è­˜æ±º') {
            initiateVoting(finalItem, mode);
          } else {
            alert(`âš ï¸ æœªçŸ¥æ±ºå®šæ¨¡å¼ï¼Œé è¨­æ¡ç”¨ä¸€æŠ½å…¥é­‚`);
            db.ref(`rooms/${roomId}/finalResult`).set(finalItem); // è¨˜éŒ„æœ€çµ‚çµæœ
            showFinalResult(finalItem);
          }
        }
      }, 50);
    });
  });
}


function chooseDecisionMode() {
  showModal('é¸æ“‡æ±ºå®šæ–¹å¼', [
    { text: 'ä¸€æŠ½å…¥é­‚', onClick: () => setDecisionMode('ä¸€æŠ½å…¥é­‚') },
    { text: 'å¤šæ•¸æ±º', onClick: () => setDecisionMode('å¤šæ•¸æ±º') },
    { text: 'å…±è­˜æ±º', onClick: () => setDecisionMode('å…±è­˜æ±º') },
  ]);
}

function setDecisionMode(mode) {
  const roomId = localStorage.getItem('currentRoomId');
  db.ref(`rooms/${roomId}/decisionMode`).set(mode);
  document.getElementById('selectedMode').textContent = `å·²é¸æ“‡ï¼š${mode}`;
}
function showFinalResult(result) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  const modalContent = document.createElement('div');
  modalContent.className = 'modal-content';
  modalContent.innerHTML = `
    <h2 style="font-size:2em;">ğŸ‰ æœ€çµ‚çµæœ ğŸ‰</h2>
    <p style="font-size:1.8em; color:#3db8c4; font-weight:bold; margin: 20px 0;">${result}</p>
    <p style="font-size:1em;">æ­å–œï¼æœ¬æ¬¡æŠ½ç±¤å·²å®Œæˆ</p>
  `;

  // å½©å¸¶ç‰¹æ•ˆï¼ˆç°¡æ˜“å‹•ç•«ï¼‰
  confettiEffect();

  const btn = document.createElement('button');
  btn.className = 'btn-confirm';
  btn.textContent = 'é—œé–‰';
  btn.onclick = () => modal.remove();
  modalContent.appendChild(btn);

  modal.appendChild(modalContent);
  document.body.appendChild(modal);
}

// å¯é¸æ“‡æ˜¯å¦ä½¿ç”¨ï¼Œå¦‚ä¸è¦å¯åˆªé™¤

function confettiEffect() {
  for (let i = 0; i < 30; i++) {
    const confetti = document.createElement('div');
    confetti.textContent = 'ğŸŠ';
    confetti.style.position = 'fixed';
    confetti.style.top = '-50px';
    confetti.style.left = Math.random() * 100 + 'vw';
    confetti.style.fontSize = '2em';
    confetti.style.animation = `fall ${2 + Math.random() * 3}s linear forwards`;
    document.body.appendChild(confetti);

    confetti.addEventListener('animationend', () => {
      confetti.remove();
    });
  }
}

// åŠ å…¥ç°¡æ˜“ falling å‹•ç•«
const style = document.createElement('style');
style.textContent = `
@keyframes fall {
  to {
    transform: translateY(110vh) rotate(360deg);
    opacity: 0;
  }
}
`;
document.head.appendChild(style);

function initiateVoting(finalItem, mode) {
  const roomId = localStorage.getItem('currentRoomId');
  const voteRef = db.ref(`rooms/${roomId}/vote`);

  // æ¸…é™¤å…ˆå‰æŠ•ç¥¨ç´€éŒ„
  voteRef.set({
    item: finalItem,
    mode: mode,
    votes: {}
  });

  // ç™¼é€æŠ•ç¥¨å½ˆçª—çµ¦ä½¿ç”¨è€…
  showModal(`æ˜¯å¦åŒæ„å°‡ "${finalItem}" ä½œç‚ºæœ€çµ‚çµæœï¼Ÿ`, [
    {
      text: 'åŒæ„',
      class: 'btn-confirm',
      onClick: () => {
        const userId = localStorage.getItem('currentUserId');
        voteRef.child('votes').child(userId).set(true);
      }
    },
    {
      text: 'ä¸åŒæ„',
      class: 'btn-primary',
      onClick: () => {
        const userId = localStorage.getItem('currentUserId');
        voteRef.child('votes').child(userId).set(false);
      }
    }
  ]);

  // ç›£è½æŠ•ç¥¨é€²åº¦
  db.ref(`rooms/${roomId}/participants`).once('value').then(snap => {
    const participants = snap.val() || {};
    const total = Object.keys(participants).length;

    voteRef.child('votes').on('value', snapshot => {
      const votes = snapshot.val() || {};
      const agreeCount = Object.values(votes).filter(v => v === true).length;
      const disagreeCount = Object.values(votes).filter(v => v === false).length;

      // åˆ¤æ–·æŠ•ç¥¨çµæŸæ¢ä»¶
      if (Object.keys(votes).length === total) {
        voteRef.child('votes').off(); // åœæ­¢ç›£è½

        if (mode === 'å¤šæ•¸æ±º' && agreeCount > total / 2) {
db.ref(`rooms/${roomId}/finalResult`).set(finalItem);

          showFinalResult(finalItem);
        } else if (mode === 'å…±è­˜æ±º' && agreeCount === total) {
db.ref(`rooms/${roomId}/finalResult`).set(finalItem);

          showFinalResult(finalItem);
        } else {
          showModal('âŒ æœªé”æˆæ¢ä»¶ï¼Œè«‹é‡æ–°æŠ½ç±¤', [
            { text: 'å¥½çš„', class: 'btn-primary', onClick: () => voteRef.remove() }
          ]);
        }
      }
    });
  });
}
function leaveRoom() {
    showModal('ç¢ºå®šè¦é›¢é–‹æ­¤æˆ¿é–“å—ï¼Ÿ', [
        {
            text: 'ç¢ºå®š',
            class: 'btn-confirm',
            onClick: () => {
                // æ¸…é™¤ localStorage è³‡æ–™
                localStorage.removeItem('currentRoomId');
                localStorage.removeItem('currentUserId');

                // å°å› index.html
                window.location.href = 'index.html';
            }
        },
        {
            text: 'å–æ¶ˆ',
            class: 'btn-primary',
            onClick: () => {}
        }
    ]);
}

</script>
</body>
</html>



