<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<!-- 分頁用 -->
<link rel="icon" type="image/png" sizes="32x32" href="icon.png">

<!-- iOS 主畫面用 -->
<link rel="apple-touch-icon" sizes="180x180" href="icon.png">

<!-- Android PWA -->
<link rel="manifest" href="manifest.json">
  <meta charset="UTF-8">
  <title>選擇小幫手</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f0f9ff;
      margin: 0;
      padding: 0;
    }
    .footer-note {
  position: fixed;
  bottom: 10px;
  right: 15px;
  font-size: 0.9em;
  color: #aaa;
  font-style: italic;
  pointer-events: none;
  user-select: none;
}
    .nav {
      display: flex;
      justify-content: center;
      background-color: #a8dadc;
      padding: 10px 0;
      flex-wrap: wrap;
    }
    .nav button {
      font-size: 16px;
      padding: 10px 20px;
      margin: 6px;
      border: none;
      background-color: #ffffff;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transition: all 0.2s ease;
    }
    .nav button.active {
      background-color: #ffe066;
      font-weight: bold;
      transform: scale(1.05);
    }
    .page {
      display: none;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    .page.active {
      display: block;
    }
    h1 {
      text-align: center;
      padding: 20px;
      color: #2c3e50;
      margin: 0;
    }
    .btn-primary {
      background-color: #3db8c4;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
.btn-primary:hover {
  background-color: #35a4af;
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.btn-primary:active {
  background-color: #2d8e98;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2) inset;
}
    .btn-yellow {
      background-color: #fff3b0;
      color: #333;
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 16px;
      margin: 4px;
      cursor: pointer;
    }
    input, select, button {
      padding: 10px;
      font-size: 16px;
      margin: 6px 4px 10px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    input, select {
      width: 100%;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    li {
      background: #e9fce6;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    li span {
      flex-grow: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .remove-btn {
      background: none;
      border: none;
      color: #c0392b;
      font-size: 18px;
      cursor: pointer;
      margin-left: 10px;
      flex-shrink: 0;
    }
    .random-container {
      text-align: center;
      margin-top: 20px;
    }
    .result-card {
      margin-top: 30px;
      padding: 30px;
      background: linear-gradient(145deg, #fff8dc, #fff6ae);
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      font-size: 2.2em;
      font-weight: bold;
      color: #b34400;
      opacity: 0;
      transform: scale(0.5);
      transition: all 0.6s ease;
        white-space: nowrap;             /* 不換行 */
  overflow: hidden;                /* 超出隱藏 */
  text-overflow: ellipsis;        /* 加上省略號（可選） */
  font-size: clamp(1.5em, 7vw, 3em); /* 自動縮放文字大小，避免換行 */
    }
    .result-card.show {
      opacity: 1;
      transform: scale(1);
    }
    .result-card.glow {
      animation: multiGlow 1.8s ease-out;
      animation-fill-mode: both;
    }
    @keyframes fadeOutShrink {
  0% {
    opacity: 1;
    transform: scale(1);
  }
  100% {
    opacity: 0;
    transform: scale(0.6);
  }
}

.result-card.fade-out {
  animation: fadeOutShrink 0.4s ease forwards;
}
    @keyframes multiGlow {
      0%   { box-shadow: 0 0 0 transparent; }
      20%  { box-shadow: 0 0 20px #ffd700; }
      40%  { box-shadow: 0 0 25px #ffffff; }
      60%  { box-shadow: 0 0 30px #ff8c00; }
      80%  { box-shadow: 0 0 25px #ffe066; }
      100% { box-shadow: 0 0 20px #ffd700; }
    }
    .current-list-label {
      font-size: 16px;
      margin-bottom: 10px;
      color: #333;
    }
    .current-list-label select {
      font-weight: bold;
      color: #2c3e50;
      background-color: #fff;
      border: 1px solid #aaa;
    }

    .btn-pink {
      background-color: #fcebeb;
      color: #333;
      border: none;
      border-radius: 5px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-lightblue {
      background-color: #e0f4ff;
      color: #333;
      border: none;
      border-radius: 5px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
    }
.slot-machine {
  display: none; /* ← 初始不顯示 */
  height: 60px;
  overflow: hidden;
  position: relative;
  margin: 30px auto 0;
  width: 80%;
  max-width: 300px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  font-size: 26px;
  font-weight: bold;
  text-align: center;
  color: #b34400;
  border: 3px dashed #ffe066;
  opacity: 0;
  transition: all 0.4s ease;
}

.slot-machine.show {
  display: block;
  opacity: 1;
}

.slot-content {
  display: flex;
  flex-direction: column;
  animation: spinScroll 3.2s ease-out forwards;
}

@keyframes spinScroll {
  0%   { transform: translateY(0); }
  100% { transform: translateY(-100%); }
}
.current-list-label {
  width: 100%;
  margin: 10px 0;
}

.label-left {
  text-align: left;
  font-size: 1.2em;
  margin-bottom: 4px;
  padding-left: 12px;
}

.select-center {
  display: flex;
  justify-content: center;
  width: 100%;
}

.select-center select {
  min-width: 160px;
  max-width: 80vw;
  font-size: 1em;
  text-align: center;       /* ← 控制開啟下拉選單時的選項置中 */
  text-align-last: center;  /* ← 控制已選文字在框中置中 */
}
#effectSelectorContainer {
  margin: 20px auto 0 auto;
  text-align: center;
  position: absolute;  /* ✅ 加這一行 */
  width: 100%;         /* ✅ 可選，確保置中對齊 */
  left: 0;             /* ✅ 固定左側 */
}

#effectSelect {
  appearance: none;
  font-size: 16px;
  padding: 10px 16px;
  color: #666;
  background-color: #f0f9ff;  /* 與整體底色統一 */
  border: none;               /* 移除邊框 */
  border-radius: 8px;
  font-weight: 500;
  width: auto;
  max-width: 80vw;
  text-align-last: center;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: background-color 0.2s ease, box-shadow 0.2s ease;
}

#effectSelect:hover {
  background-color: #e0f4ff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.08);
}

#effectSelect:focus {
  outline: none;
  background-color: #d0ecff;
  box-shadow: 0 0 0 3px rgba(61, 184, 196, 0.2);
}



.video-wrapper {
  width: 100%;
  max-width: 420px;
  margin: 30px auto 20px auto;
  position: relative;
  overflow: hidden;
  border-radius: 20px;
  box-shadow: 0 0 20px rgba(255, 223, 0, 0.4);
  pointer-events: none;
  max-height: 240px;          /* ✅ 限制最大高度 */
  min-height: 200px;       /* ✅ 預留高度避免畫面突然撐開 */
  opacity: 0;              /* ✅ 一開始隱藏 */
  transition: opacity 0.3s ease;
}
.video-wrapper.show {
  opacity: 1;              /* ✅ 出現時淡入 */
}

.custom-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 20px;
  mask-image: radial-gradient(circle at center, rgba(0,0,0,1) 60%, rgba(0,0,0,0) 100%);
  mask-composite: exclude;
}

.video-wrapper.glow-out {
  animation: glowOut 1s ease forwards;
}

@keyframes glowOut {
  0% {
    box-shadow: 0 0 20px rgba(255, 200, 0, 0.6);
    opacity: 1;
    transform: scale(1);
  }
  100% {
    box-shadow: 0 0 80px rgba(255, 255, 0, 0.2);
    opacity: 0;
    transform: scale(1.4);
    margin-bottom: -200px; /* ← 強制壓縮空間 */
    visibility: hidden;
  }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
  to   { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}
.result-card.transitioning {
  opacity: 0;
  transform: scale(0.9);
}

.result-card.reveal {
  transition: all 0.6s ease;
  opacity: 1;
  transform: scale(1);
}
.btn-primary.disabled {
  background-color: #ddd !important;
  color: #999 !important;
  cursor: not-allowed !important;
  box-shadow: none !important;
  transform: none !important;
}
.fade-out-smooth {
  opacity: 0;
  transition: opacity 0.6s ease;
}

.fade-in-smooth {
    opacity: 1;
    transition: opacity 0.6s ease;
    visibility: visible; /* ✅ 加上這行 */
}

@keyframes shake {
  0% { transform: translateX(0); }
  20% { transform: translateX(-6px); }
  40% { transform: translateX(6px); }
  60% { transform: translateX(-4px); }
  80% { transform: translateX(4px); }
  100% { transform: translateX(0); }
}

.shake {
  animation: shake 0.4s;
  will-change: transform; /* 提前通知瀏覽器加速渲染，減少撕裂 */
}

@keyframes dropAndShrink {
  0% {
    opacity: 0;
    transform: translateY(-150px) scale(1.4);
  }
  50% {
    opacity: 1;
    transform: translateY(20px) scale(0.9);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.result-card.drop-in {
  animation: dropAndShrink 0.7s ease forwards;
}
@keyframes fadeInEffectSelector {
  0% { opacity: 0; }
  100% { opacity: 1; }
}
.fade-in-anim {
  animation: fadeInEffectSelector 0.6s ease forwards;
}
@keyframes fadeInEffectSelector {
  0% { opacity: 0; }
  100% { opacity: 1; }
}
.fade-in-anim {
  animation: fadeInEffectSelector 0.6s ease forwards;
}
.fade-out-smooth {
  opacity: 0;
  transition: opacity 0.6s ease;
}
@keyframes refreshFadeScale {
  0% {
    opacity: 0;
    transform: scale(0.8);
    filter: brightness(1.3);
  }
  50% {
    opacity: 1;
    transform: scale(1.05);
    filter: brightness(1);
  }
  100% {
    transform: scale(1);
    filter: brightness(1);
  }
}

.result-card.refresh-fade-scale {
  animation: refreshFadeScale 0.5s ease;
}

body.dark-mode {
  background-color: #1e1e1e;
  color: #ddd;
}

body.dark-mode .nav {
  background-color: #333;
}

body.dark-mode .nav button {
  background-color: #555;
  color: #eee;
}

body.dark-mode .nav button.active {
  background-color: #888;
}

body.dark-mode .page {
  background-color: #1e1e1e;
}

body.dark-mode h1 {
  color: #eee;
}

body.dark-mode .btn-primary {
  background-color: #555;
  color: #ddd;
}

body.dark-mode .btn-primary:hover {
  background-color: #666;
}

body.dark-mode .btn-pink {
  background-color: #664;
  color: #ddd;
}

body.dark-mode .btn-lightblue {
  background-color: #334;
  color: #ddd;
}

body.dark-mode input,
body.dark-mode select,
body.dark-mode button {
  background-color: #333;
  color: #ddd;
  border: 1px solid #555;
}

body.dark-mode li {
  background: #333;
  color: #ddd;
}

body.dark-mode .result-card {
  background: linear-gradient(145deg, #333, #444);
  color: #ffe066;
}

body.dark-mode #effectSelect {
  background-color: #333;
  color: #ddd;
}

body.dark-mode .slot-machine {
  background-color: #333;
  color: #ffe066;
  border-color: #555;
}

body.dark-mode .footer-note {
  color: #666;
}


  </style>
</head>
<body>
<button id="darkModeToggle" title="切換深色模式" style="
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 999;
  background: #fff;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  font-size: 18px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
">🌙</button>

<h1><img src="https://cdn.jsdelivr.net/gh/a355226/choosehelper@main/icon.png" alt="icon" width="32">
選擇小幫手</h1>

<div class="nav">
  <button class="active" onclick="showPage('randomPage')">🎯 快速決定</button>
  <button onclick="showPage('editPage')">📝 編輯清單</button>
</div>

<div class="page active" id="randomPage">
  <div class="current-list-label">
  <div class="label-left">目前清單：</div>
  <div class="select-center">
    <select id="topMemorySelect" onchange="switchMemoryFromTop()">
      <option value="">-- 請選擇 --</option>
    </select>
  </div>
  </div>
  <div class="random-container">

    <button class="btn-primary" style="width:100%; font-size:20px;" onclick="chooseRandom()">🎲 隨機選 🎲</button>
    <div id="resultCard" class="result-card">請先建立清單</div>
<div id="slotMachine" class="slot-machine"></div>
    <div id="appealArea"></div>
  </div>
</div>

  <div id="effectSelectorContainer" style="margin-top: 80px; text-align: center;">
  <label for="effectSelect" style="font-weight: bold;"></label>
<select id="effectSelect" onchange="handleEffectChange()">
  <option value="default">預設</option>
  <option value="video001">恐怖貞子</option>
  <option value="video002">德州撲克</option>
  <option value="video003">可愛貓咪</option>
  <option value="video004">外星生物</option>
  <option value="video005">尾牙抽獎</option>
  <option value="random">隨機</option>
</select>
</div>


<div class="page" id="editPage">
  <div class="section-title">📂 切換清單：</div>
  <select id="memorySelect" onchange="loadMemoryList()">
    <option value="">-- 請選擇 --</option>
  </select>
<button class="btn-lightblue" onclick="openSortModal()">🔃排序</button>

  <button class="btn-pink" onclick="deleteMemoryList()">🗑 刪除清單</button>

  <div class="section-title">🖊 輸入項目：</div>
  <input type="text" id="foodInput" placeholder="請輸入" />
  <button class="btn-primary" onclick="addFood()">加入</button>
  <button class="btn-lightblue" onclick="saveCurrentList()">建立</button>
  <button class="btn-lightblue" onclick="updateCurrentList()">更新</button>
  <button class="btn-pink"  onclick="clearAllItems()">全部清除</button>
  <div class="section-title">📃 目前清單：</div>
  <ul id="foodList"></ul>
  <div style="margin-top: 70px;">
    <button class="btn-lightblue" onclick="shareList()">匯出</button>
    <button class="btn-lightblue" onclick="importList()">匯入</button>
  </div>
</div>

<script>
let currentSortable = null; // 全域保存 Sortable 實例
window._introPlayed = false; // ✅ 用於控制切頁時動畫只跑一次
window._introPlayed = false;

let currentList = [];
let memoryData = JSON.parse(localStorage.getItem('memoryData')) || {};
let currentListName = "";

function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    const btn = id === 'randomPage' ? document.querySelectorAll('.nav button')[0] : document.querySelectorAll('.nav button')[1];
    btn.classList.add('active');

    if (id === 'randomPage') {
        const slotMachine = document.getElementById('slotMachine');
        const resultCard = document.getElementById('resultCard');
        const appealArea = document.getElementById('appealArea');
        slotMachine.innerHTML = '';
        slotMachine.classList.remove('show');

        if (!currentListName || currentList.length === 0) {
            resultCard.textContent = '先選擇清單';
        } else {
            resultCard.textContent = `來決定「${currentListName}」!`;
        }

        resultCard.classList.remove('glow', 'show');
        appealArea.innerHTML = '';
        enableRandomButton();

        // ✅ 僅第一次切換時播放動畫，避免多次排程錯亂
        if (!window._introPlayed) {
            window._introPlayed = true; // ⚡️ 標記已觸發
            setTimeout(() => {
                revealIntroText();
            }, 300);
        }
    }

    const effectContainer = document.getElementById('effectSelectorContainer');
    effectContainer.style.display = (id === 'randomPage') ? 'block' : 'none';
}



function saveMemoryData() {
  localStorage.setItem('memoryData', JSON.stringify(memoryData));
}

function addFood() {
  const input = document.getElementById('foodInput');
  const food = input.value.trim();
  if (food) {
    currentList.push(food);
    input.value = '';
    renderCurrentList();
  }
}

function renderCurrentList() {
  const ul = document.getElementById('foodList');
  ul.innerHTML = '';
  currentList.forEach((item, index) => {
    const li = document.createElement('li');
    const span = document.createElement('span');
    span.textContent = item;
    const btn = document.createElement('button');
    btn.textContent = '✕';
    btn.className = 'remove-btn';
    btn.onclick = () => removeItem(index);
    li.appendChild(span);
    li.appendChild(btn);
    ul.appendChild(li);
  });
}
function removeItem(index) {
  currentList.splice(index, 1);
  renderCurrentList();
}

function clearAllItems() {
  if (confirm("確定要清除目前所有項目？")) {
    currentList = [];
    renderCurrentList();
  }
}

function saveCurrentList() {
  const name = prompt("請輸入此清單的名稱：");
  if (name && name.trim()) {
    memoryData[name] = [...currentList];
    currentListName = name;
    saveMemoryData();

    // 🔸修正：插入新名稱到 memoryOrder 並存回
    let memoryOrder = [];
    try { memoryOrder = JSON.parse(localStorage.getItem('memoryOrder')) || []; } catch {}
    if (!memoryOrder.includes(name)) {
      memoryOrder.push(name);
      localStorage.setItem('memoryOrder', JSON.stringify(memoryOrder));
    }

    updateMemorySelect();
    alert(`已記憶清單：「${name}」`);
  }
}


function loadMemoryList() {
  const selected = document.getElementById('memorySelect').value;
  if (!selected) {
    currentList = [];
    currentListName = "";
    renderCurrentList();
    return;
  }

  if (memoryData[selected]) {
    currentList = [...memoryData[selected]];
    currentListName = selected;
    updateMemorySelect();

    renderCurrentList();
  }
}

function switchMemoryFromTop() {
  const selected = document.getElementById('topMemorySelect').value;
  if (!selected) {
    currentList = [];
    currentListName = "";
    renderCurrentList();
    return;
  }
  if (memoryData[selected]) {
    currentList = [...memoryData[selected]];
    currentListName = selected;
    updateMemorySelect();

    renderCurrentList();
  }
}

function deleteMemoryList() {
  const selected = document.getElementById('memorySelect').value;
  if (selected && memoryData[selected]) {
    if (confirm(`確定要刪除記憶清單：「${selected}」？`)) {
      delete memoryData[selected];
      if (currentListName === selected) {
        currentListName = "";
        currentList = [];
        renderCurrentList();
      }
      saveMemoryData();
      updateMemorySelect();

      alert(`「${selected}」已刪除`);
    }
  } else {
    alert("請先選擇要刪除的清單");
  }
}

function shareList() {
  const text = JSON.stringify({ name: currentListName, items: currentList });
  if (navigator.share) {
    navigator.share({
      title: '我的選擇清單',
      text: text
    }).catch(err => alert("分享失敗：" + err));
  } else {
    prompt("請複製以下內容以分享：", text);
  }
}

function importList() {
  const text = prompt("請貼上分享內容：");
  if (!text) return;
  try {
    const parsed = JSON.parse(text);
    if (!parsed.name || !Array.isArray(parsed.items)) throw new Error("格式錯誤");
    memoryData[parsed.name] = parsed.items;
    currentListName = parsed.name;
    currentList = [...parsed.items];
    saveMemoryData();
    updateMemorySelect();

    renderCurrentList();
    alert(`成功匯入清單：「${parsed.name}」`);
  } catch (e) {
    alert("❌ 匯入失敗：格式錯誤");
  }
}

// 初始化
updateMemorySelect();

renderCurrentList();

// ✅ 修正：恢復上次使用的特效（讓 effectSelect 記住使用者選擇）
const lastEffect = localStorage.getItem('lastEffect') || 'default';
document.getElementById('effectSelect').value = lastEffect;

let appealCount = 3;
let lastIndex = -1; // 記錄上次的結果位置

function secureRandomIndex(max) {
  const arr = new Uint32Array(1);
  window.crypto.getRandomValues(arr);
  return Math.floor(arr[0] / (2**32) * max);
}

function chooseRandom(isAppeal = false) {window._introPlayed = false; // ✅ 點擊抽籤後，下次切頁會重新播放動畫
window._resultShown = false; // ✅ 每次抽選前重置

  if (!currentListName || currentList.length === 0) {
    const randomBtn = document.querySelector('.btn-primary');
    randomBtn.classList.add('shake');

    // 同時彈出提示
    setTimeout(() => {
      alert("🚫 請先選擇清單");
      randomBtn.classList.remove('shake');
    }, 50);

    return;
  } 
  randomBtn.classList.add('disabled');
  randomBtn.disabled = true;

  const resultCard = document.getElementById('resultCard');
  const appealArea = document.getElementById('appealArea');
  const slotMachine = document.getElementById('slotMachine');
  const effectContainer = document.getElementById('effectSelectorContainer'); // ← 新增
 slotMachine.style.display = ''; 

  let effect = document.getElementById('effectSelect')?.value || 'default';

// 如果是隨機，從 default 與 5 個影片隨機選一個
if (effect === 'random') {
    const options = ['default', 'video001', 'video002', 'video003', 'video004', 'video005'];
    effect = options[Math.floor(Math.random() * options.length)];
}


  if (!isAppeal) appealCount = 3;
  appealArea.innerHTML = '';

  // ➤ 清除影片區
  const oldWrapper = document.querySelector('.video-wrapper');
  if (oldWrapper) oldWrapper.remove();

  // ➤ 重置拉霸動畫
  slotMachine.innerHTML = '';
  slotMachine.classList.remove('show');

// ✅ 僅第一次隨機選 / 上訴時淡出，之後過程中不會再次淡出
if (effectContainer.style.display !== 'none') {
    effectContainer.classList.remove('fade-in-smooth', 'fade-in-anim');
    effectContainer.classList.add('fade-out-smooth');
    setTimeout(() => {
        effectContainer.style.visibility = 'hidden';
        effectContainer.classList.remove('fade-out-smooth');
    }, 600);
}





if (['video001', 'video002', 'video003', 'video004', 'video005'].includes(effect)) {
    resultCard.style.display = 'none';
    playVideoEffect(resultCard, effect);
} else {
    // ✅ 拉霸前記錄穩定位置（首次執行時記錄）
    if (!window.effectSelectorStableTop) {
        const rect = effectContainer.getBoundingClientRect();
        const scrollTop = window.scrollY || window.pageYOffset;
        window.effectSelectorStableTop = rect.top + scrollTop;
    }
    // ✅ 使用穩定位置鎖定 Effect Selector，避免被推下
    effectContainer.style.position = 'fixed';
    effectContainer.style.top = window.effectSelectorStableTop + 'px';

    resultCard.textContent = '🎰 正在抽籤...';
    resultCard.classList.add('show', 'glow');

    runSlotAnimation();
}

}

function updateCurrentList() {
  if (!currentListName) {
    alert("⚠️ 尚未選擇任何記憶清單，請先選擇一個要更新的清單");
    return;
  }
  memoryData[currentListName] = [...currentList];
  saveMemoryData();
  alert(`✅ 已更新清單：「${currentListName}」`);
  updateMemorySelect();// 可選，有時候會刷新下拉選單顯示狀態
// ✅ 套用上次使用的特效
const lastEffect = localStorage.getItem('lastEffect') || 'default';
const effectSelect = document.getElementById('effectSelect');
if (effectSelect) {
    effectSelect.value = lastEffect;
}
}

 function runSlotAnimation() {
  // ✅ 執行拉霸前固定 Effect Selector 位置避免跳動
const effectContainer = document.getElementById('effectSelectorContainer');
  const slotMachine = document.getElementById('slotMachine');
  const resultCard = document.getElementById('resultCard');
  const appealArea = document.getElementById('appealArea');

  let finalIndex = secureRandomIndex(currentList.length);
  lastIndex = finalIndex;

  const spinList = [];
  for (let i = 0; i < 90; i++) {
    spinList.push(currentList[secureRandomIndex(currentList.length)]);
  }
  spinList.push(currentList[finalIndex]);

  const slotContent = document.createElement('div');
  slotContent.className = 'slot-content';
  slotContent.style.animation = 'none';
  slotContent.innerHTML = spinList.map(item => `<div>${item}</div>`).join('');
  slotMachine.innerHTML = '';
  slotMachine.appendChild(slotContent);

  slotMachine.classList.add('show');
  void slotContent.offsetWidth;
  slotContent.style.animation = 'spinScroll 3.2s ease-out forwards';

  setTimeout(() => {
    revealResult();
  }, 3300);
}
function revealResult(currentEffect)  {

console.log('[DEBUG] revealResult currentEffect =', currentEffect);
if (window._revealRunning) return;
window._revealRunning = true;
setTimeout(() => window._revealRunning = false, 1500);

    const effectContainer = document.getElementById('effectSelectorContainer');
    const resultCard = document.getElementById('resultCard');
    const appealArea = document.getElementById('appealArea');
    const slotMachine = document.getElementById('slotMachine');

    // ✅ 修正：先清除 refresh-fade-scale，避免污染影片特效
    resultCard.classList.remove('refresh-fade-scale');

  // 測量穩定位置一次記錄
  if (!window.effectSelectorStableTop) {
    const rect = effectContainer.getBoundingClientRect();
    const scrollTop = window.scrollY || window.pageYOffset;
    window.effectSelectorStableTop = rect.top + scrollTop;
  }

  setTimeout(() => {
    resultCard.style.display = '';
}, 50);

  const finalIndex = lastIndex >= 0 ? lastIndex : secureRandomIndex(currentList.length);
resultCard.textContent = `🎉 ${currentList[finalIndex]}`;
window._resultShown = true; // ✅ 標記結果已顯示

requestAnimationFrame(() => {
    requestAnimationFrame(() => {
        resultCard.classList.add('show', 'glow', 'drop-in');

        // 只有在需要時加上 refresh-fade-scale
        if (currentEffect === 'default' || currentEffect === 'random') {
            resultCard.classList.add('refresh-fade-scale');
        }
    });
});
resultCard.classList.remove('drop-in');

requestAnimationFrame(() => {
    requestAnimationFrame(() => {
        resultCard.classList.add('show', 'glow', 'drop-in');
    });
});

    // ✅ 修正核心：顯式使用傳入的 currentEffect
    currentEffect = currentEffect || document.getElementById('effectSelect').value;
    if (currentEffect === 'default' || currentEffect === 'random') {
        resultCard.classList.remove('refresh-fade-scale');
        void resultCard.offsetWidth;
        resultCard.classList.add('refresh-fade-scale');
    }


  // ✅ 刷新特效：在結果顯示時套用一次刷新動畫
  resultCard.classList.add('refresh-pulse');
  resultCard.addEventListener('animationend', () => {
    resultCard.classList.remove('refresh-pulse');
  }, { once: true });

 // 將插入上訴按鈕的程式碼延後到動畫完全完成後再插入
setTimeout(() => {
    if (appealCount > 0) {
        const btn = document.createElement('button');
        btn.textContent = `上訴！（剩餘${appealCount}次）`;
        btn.className = 'btn-pink';
        btn.style.marginTop = '20px';
        btn.style.backgroundColor = ['#ffe6e6', '#ffb3b3', '#ff6666'][3 - appealCount] || '#ff6666';
        btn.style.color = '#800000';
        btn.onclick = () => {
            appealCount--;
            chooseRandom(true);
        };
        appealArea.appendChild(btn);
    } else {
        const finalText = document.createElement('div');
        finalText.textContent = '認命吧，這就是最好的選擇！';
        finalText.style.marginTop = '20px';
        finalText.style.fontWeight = 'bold';
        finalText.style.color = '#b34400';
        appealArea.appendChild(finalText);
    }
}, 50); // 建議延遲 600~800 ms，與動畫時間對齊

  enableRandomButton();

  // ✅ 淡出 slot-machine
  slotMachine.classList.remove('show');
  slotMachine.style.display = 'none';

  // 拉霸結束後恢復原本定位
  effectContainer.style.position = 'absolute';
  effectContainer.style.top = '';
  delete window.effectSelectorStableTop; // ✅ 恢復後清除暫存

  // ✅ 修正淡入效果確實觸發
setTimeout(() => {
    effectContainer.classList.remove('fade-in-anim', 'fade-in-smooth', 'fade-out-smooth');
    effectContainer.style.visibility = 'visible';
    void effectContainer.offsetWidth;                // 強制重排以確保動畫觸發
    effectContainer.classList.add('fade-in-anim');   // 執行動畫
}, 100);


}


  const v = Date.now(); // 每次刷新都帶入唯一值，避開快取
document.querySelectorAll('link[rel="icon"], link[rel="manifest"]').forEach(el => {
  if (el.href) {
    el.href += (el.href.includes('?') ? '&' : '?') + 'v=' + v;
  }
});
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js?v=' + v)
    .then(reg => console.log('SW 註冊成功', reg.scope))
    .catch(err => console.log('SW 註冊失敗', err));
}
const randomBtn = document.querySelector('.btn-primary');
randomBtn.classList.remove('disabled');
randomBtn.disabled = false;




function enableRandomButton() {
  const randomBtn = document.querySelector('.btn-primary');
  randomBtn.classList.remove('disabled');
  randomBtn.disabled = false;
}

function fadeOutAndHide(element) {
    element.classList.add('fade-out-smooth');
}


function playVideoEffect(resultCard, effect) {
    const wrapper = document.createElement('div');
    wrapper.className = 'video-wrapper';
    document.querySelector('.random-container').insertBefore(wrapper, resultCard);

    const video = document.createElement('video');
    const videoMap = {
    'video001': 'https://cdn.jsdelivr.net/gh/a355226/choosehelper@main/video001.mp4',
    'video002': 'https://cdn.jsdelivr.net/gh/a355226/choosehelper@main/video002.mp4',
    'video003': 'https://cdn.jsdelivr.net/gh/a355226/choosehelper@main/video003.mp4',
    'video004': 'https://cdn.jsdelivr.net/gh/a355226/choosehelper@main/video004.mp4',
    'video005': 'https://cdn.jsdelivr.net/gh/a355226/choosehelper@main/video005.mp4',
};
video.src = videoMap[effect] || videoMap['video001'];

    video.autoplay = true;
    video.playsInline = true;
    video.muted = true;
    video.className = "custom-video";

    wrapper.appendChild(video);
// ✅ 播放影片前固定 Effect Selector 位置避免跳動
const effectContainer = document.getElementById('effectSelectorContainer');
const rect = effectContainer.getBoundingClientRect();
const scrollTop = window.scrollY || window.pageYOffset;
effectContainer.style.position = 'fixed';
effectContainer.style.top = (rect.top + scrollTop) + 'px';
    // 出現動畫
    setTimeout(() => {
        wrapper.classList.add('show');
    }, 50);

video.onended = () => {
    wrapper.classList.add('glow-out');
    setTimeout(() => {
        wrapper.remove();

        // ✅ 播放影片後恢復原本定位
        effectContainer.style.position = 'absolute';
        effectContainer.style.top = '';

        revealResult(effect);// 顯示最終結果
    }, 1000);
};
}

  function handleEffectChange() {
    const effect = document.getElementById('effectSelect').value;
    localStorage.setItem('lastEffect', effect);
}

// 深色模式切換與記憶
const darkModeToggle = document.getElementById('darkModeToggle');
if (localStorage.getItem('darkMode') === 'enabled') {
  document.body.classList.add('dark-mode');
  darkModeToggle.textContent = '☀️';
}

darkModeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  if (document.body.classList.contains('dark-mode')) {
    localStorage.setItem('darkMode', 'enabled');
    darkModeToggle.textContent = '☀️';
  } else {
    localStorage.setItem('darkMode', 'disabled');
    darkModeToggle.textContent = '🌙';
  }
});
// 排序 Modal 開啟
function openSortModal() {
    const sortList = document.getElementById('sortList');
    sortList.innerHTML = '';

    Object.keys(memoryData).forEach(name => {
        const li = document.createElement('li');
        li.textContent = name;
        li.style.padding = '8px';
        li.style.margin = '4px 0';
        li.style.background = '#e9fce6';
        li.style.borderRadius = '5px';
        li.style.cursor = 'grab';
        sortList.appendChild(li);
    });

    // 修正：每次開啟前先 destroy 上一次的 sortable 實例，避免觸控無效
    if (currentSortable) {
        currentSortable.destroy();
        currentSortable = null;
    }

    currentSortable = Sortable.create(sortList, {
        animation: 150,
        touchStartThreshold: 5 // (可選) 提高容錯讓手機更易觸發拖曳
    });

    document.getElementById('sortModal').style.display = 'flex';
}


// 排序 Modal 關閉
function closeSortModal() {
    if (currentSortable) {
        currentSortable.destroy();
        currentSortable = null;
    }
    document.getElementById('sortModal').style.display = 'none';
}

// 排序結果儲存
function saveSortOrder() {
    const sortList = document.getElementById('sortList');
    const sortedNames = Array.from(sortList.children).map(li => li.textContent);
    localStorage.setItem('memoryOrder', JSON.stringify(sortedNames));
    closeSortModal();
    updateMemorySelect();
}

// 更新下拉選單使用排序
function updateMemorySelect() {
    const selects = [document.getElementById('memorySelect'), document.getElementById('topMemorySelect')];

    let memoryOrder = [];
    try {
        memoryOrder = JSON.parse(localStorage.getItem('memoryOrder'));
    } catch(e) {
        memoryOrder = null;
    }
    if (!Array.isArray(memoryOrder) || memoryOrder.length === 0) {
        memoryOrder = Object.keys(memoryData);
    }

    selects.forEach(select => {
        select.innerHTML = '<option value="">-- 請選擇 --</option>';
        memoryOrder.forEach(name => {
            if (memoryData[name]) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (name === currentListName) option.selected = true;
                select.appendChild(option);
            }
        });
    });
}
function revealIntroText() {
    if (window._resultShown) return; // 若已顯示結果，不重播動畫
    if (window._introTextAnimating) return; // 防止重複觸發

    const resultCard = document.getElementById('resultCard');

    const text = resultCard.textContent.trim();
    if (text === '先選擇清單' || text.startsWith('來決定「')) {
        // ⚠️ 如果是提示文字，直接顯示並保持，不執行動畫重置
        resultCard.style.opacity = 1;
        resultCard.style.transform = 'scale(1)';
        resultCard.classList.add('show'); // 保證可見
        return;
    }

    window._introTextAnimating = true;

    resultCard.classList.remove('drop-in', 'refresh-fade-scale', 'glow', 'show');

    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            resultCard.classList.add('show', 'glow', 'drop-in');
            setTimeout(() => { window._introTextAnimating = false; }, 800);
        });
    });
}




</script>

  <div class="footer-note">Designed by KJ&nbsp;&nbsp;</div>

<div id="sortModal" style="
  display:none; 
  position:fixed; 
  top:0; 
  left:0; 
  width:100%; 
  height:100%; 
  background:rgba(0,0,0,0.5); 
  align-items:center; 
  justify-content:center; 
  z-index:9999;">
  <div style="
    background:#fff; 
    padding:20px; 
    border-radius:8px; 
    max-width:300px; 
    width:90%;">
    <h3>拖曳排序清單</h3>
    <ul id="sortList" style="list-style:none; padding:0; max-height:300px; overflow:auto;"></ul>
    <button class="btn-primary" onclick="saveSortOrder()">儲存順序</button>
    <button class="btn-pink" onclick="closeSortModal()">關閉</button>
  </div>
</div>

</body>
</html>










